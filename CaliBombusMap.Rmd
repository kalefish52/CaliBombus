---
title: "CaliBombus Spatial"
output: html_document
---

#Load Packages
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(sf)
library(tmap)
library(sp)
library(spatialEco)
library(rgdal)
library(stringr)


```

#Import data from EPA/USGS and CaliBombus
## Note: USGS is in a projected coordinate system and GPS coordinates are in a geographic coordinate system 
### It is best too use projected coordinate system for geospatial analyses
I used the SF package, sp package and rgal package
The SF transformation function wasn't changing the lat/long coordinates to xy 
Also changed NA_L3Names so they are shorter 
```{r}
#Import ecoregion shape file from EPA/USGS Level III 
ecoregionshape<-st_read("./ca_eco_l3/ca_eco_l3.shp") #sf package
#Check coordinate reference system 
st_crs(ecoregionshape) #sf package
# Coordinate reference system is USA_Contiguous_Albers_Equal_Area_Conic_USGS_version
# Datum is North American Datum 1983

##Recode variable names so they are shorter 
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Coast Range' = "Coast Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central Basin and Range' = "Central Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Mojave Basin and Range' = "Mojave Basin Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sierra Nevada' = "Sierra Nevada")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'California Coastal Sage, Chaparral, and Oak Woodlands' = "Coastal Sage")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central California Valley' = "Central California Valley")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Klamath Mountains' = "Klamath")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Southern and Baja California Pine-Oak Mountains' = "Southern California Mountains")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Northern Basin and Range' = "Northern Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sonoran Desert' = "Sonoran Desert")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Eastern Cascades Slopes and Foothills' = "Eastern Cascades")

#Condense ecoregion to name and geometry (ie. coordinates)
ecoregions<-ecoregionshape %>% select(NA_L3NAME, geometry)

#Read in site gps coordinates
site<-read.csv("./spatialinfofinal.csv") %>% select(Site_Grouping, lon, lat) 

#Convert lat/long data to epsg 5070 to match ecoregion projection in rgdal package
cords<-SpatialPoints(cbind(site$lon, site$lat), proj4string=CRS("+proj=longlat"))
coordscon<-spTransform(cords, CRS("+init=epsg:5070"))

#Transform to data frame and add site information 
convertdata<-data.frame(coordscon) %>% cbind(site$Site_Grouping)%>% rename(site="site$Site_Grouping" ) %>% 
  rename(x="coords.x1") %>% 
  rename(y="coords.x2")
convertdata
convertdata<-convertdata %>% 
  select(site, x, y)

#Convert to sf object to match with ecoregion 
site.sf <- st_as_sf(convertdata, coords=c("x", "y"), crs=5070) 
site.sf

#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Calibombussites_ecoregions<-point.in.poly(site.sf, ecoregions) %>% as.data.frame()
Calibombussites_ecoregions
```
#Make a pretty map 
```{r}
#Map without labels
tm_shape(ecoregions) + tm_style("col_blind")+
  tm_polygons(col="NA_L3NAME", border.col="white", palette="Dark2", title="Ecoregion")+
  tm_shape(site.sf) + tm_dots(size=0.2, col="black")+
 tm_layout(frame=FALSE, legend.text.size=0.7, legend.width=1)+tm_legend(legend.position=c("right", "top"), outside=TRUE) 

```

## Add historical data from Leif's dataset
# Filter by collection - ie. Bohart Collection to see if Robins 1983 paper matches these records
```{r}
Leifdata<-read.csv("./BBNACalifornia.csv")
## Make sure all is distinct 
Leifdata<-Leifdata %>% distinct(location, date, species, caste, observers, .keep_all=TRUE) 


Leifdata %>% filter(species=="suckleyi")

#Get Thorp data (identified by R. Thorp)
Robin<-Leifdata[grep("horp", Leifdata$det.by),] 
Robin %>% filter(species=="rufocinctus")

#Get J. Ascher data (identified by J. Ascher)
Ascher<-Leifdata[grep("scher", Leifdata$det.by),] 

#Get Bohart collection data - anyh remaining that Robin may have used 
Bohart<-Leifdata[grep("ohart", Leifdata$Institution),] 

#Combine all data and then make sure there are no duplicates 
FullData<-rbind(Robin, Ascher, Bohart) %>% distinct(location, date, species, caste, observers, .keep_all=TRUE) 

print(paste("We have", nrow(FullData), "datapoints from Bohart, Thorp and Ascher"))
```


# Assign each one of Leif's datapoints to an Ecoregion using USGS Level III
```{r}

AllYears<-FullData %>% select(BBNA.code, species, sex, month, year, longitude, latitude) %>% na.omit()
print(paste("We removed", (nrow(FullData)-nrow(AllYears)), "datapoints that had NA coordinates"))

#Convert lat/long data to epsg 5070 to match ecoregion projection in rgdal package
COORDSall<-SpatialPoints(cbind(AllYears$longitude, AllYears$latitude), proj4string=CRS("+proj=longlat"))
coordsall<-spTransform(COORDSall, CRS("+init=epsg:5070"))

#Transform to data frame and add site information 
convertall<-data.frame(coordsall) 
convertallcomb<-cbind(convertall, AllYears) %>% 
  rename(x="coords.x1") %>% 
  rename(y="coords.x2")
head(convertallcomb)

#Convert to sf object to match with ecoregion 
site.sf.all <- st_as_sf(convertallcomb, coords=c("x", "y"), crs=5070) 
site.sf.all

#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Allyears_ecoregion<-point.in.poly(site.sf.all, ecoregions) %>% as.data.frame()
nrow(Allyears_ecoregion) 
```

#Subset historical datapoints by decade 
```{r}
Allyearseco<-Allyears_ecoregion %>% rename(Ecoregion=NA_L3NAME)

# 1930-1959
thirtyfifty<-Allyearseco %>% filter(between(year, 1930, 1959))
print(paste("We have", nrow(thirtyfifty), "datapoints between 1930 and 1959"))

# 1960-1989
sixtyeighty<-Allyearseco %>% filter(between(year, 1960, 1989))
print(paste("We have", nrow(sixtyeighty), "datapoints between 1960 and 1989"))

# 2000-2019
twothous<-Allyearseco %>% filter(between(year, 1990, 2019))
print(paste("We have", nrow(twothous), "datapoints between 1990 and 2019"))

#data pre 83
Pre83_ecoregions<-Allyearseco %>% filter(year<="1983")
print(paste("We have", nrow(Pre83_ecoregions), "datapoints before or in 1983"))
```






