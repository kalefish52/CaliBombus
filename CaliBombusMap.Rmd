---
title: "CaliBombus Spatial"
output: html_document
---

#Load Packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(sf)
library(tmap)
library(sp)
library(spatialEco)
library(rgdal)
library(stringr)


```

#Import data from EPA/USGS and CaliBombus
## Note: USGS is in a projected coordinate system and GPS coordinates are in a geographic coordinate system 
### It is best too use projected coordinate system for geospatial analyses
I used the SF package, sp package and rgal package
The SF transformation function wasn't changing the lat/long coordinates to xy 
Also changed NA_L3Names so they are shorter 
```{r}
#Import ecoregion shape file from EPA/USGS Level III 
ecoregionshape<-st_read("./USGS_ecoregions20/ca_eco_l3.shp") #sf package
#Check coordinate reference system 
st_crs(ecoregionshape) #sf package
# Coordinate reference system is USA_Contiguous_Albers_Equal_Area_Conic_USGS_version
# Datum is North American Datum 1983

##Recode variable names so they are shorter 
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Coast Range' = "Coast Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central Basin and Range' = "Central Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Mojave Basin and Range' = "Mojave Basin Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sierra Nevada' = "Sierra Nevada")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'California Coastal Sage, Chaparral, and Oak Woodlands' = "Coastal Sage")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central California Valley' = "Central California Valley")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Klamath Mountains' = "Klamath")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Southern and Baja California Pine-Oak Mountains' = "Southern California Mountains")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Northern Basin and Range' = "Northern Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sonoran Desert' = "Sonoran Desert")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Eastern Cascades Slopes and Foothills' = "Eastern Cascades")

#Condense ecoregion to name and geometry (ie. coordinates)
ecoregions<-ecoregionshape %>% select(NA_L3NAME, geometry)

#Read in site gps coordinates
site<-read.csv("./USGS_ecoregions20/spatialinfofinal.csv") %>% select(Site_Grouping, lon, lat) 

#Convert lat/long data to epsg 5070 to match ecoregion projection in rgdal package
cords<-SpatialPoints(cbind(site$lon, site$lat), proj4string=CRS("+proj=longlat"))
coordscon<-spTransform(cords, CRS("+init=epsg:5070"))

#Transform to data frame and add site information 
convertdata<-data.frame(coordscon) %>% cbind(site$Site_Grouping)%>% rename(site="site$Site_Grouping" ) %>% 
  rename(x="coords.x1") %>% 
  rename(y="coords.x2")
convertdata<-convertdata %>% 
  select(site, x, y)

#Convert to sf object to match with ecoregion 
site.sf <- st_as_sf(convertdata, coords=c("x", "y"), crs=5070) 


#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Calibombussites_ecoregions<-point.in.poly(site.sf, ecoregions) %>% as.data.frame()
write.csv(Calibombussites_ecoregions, "./DataFrames/calibombussites_ecoregion.csv")
```
#Make a pretty map 
```{r}
#Map without labels
tm_shape(ecoregions) + tm_style("col_blind")+
  tm_polygons(col="NA_L3NAME", border.col="white", palette="Dark2", title="Ecoregion")+
  tm_shape(site.sf) + tm_dots(size=0.2, col="black")+
 tm_layout(frame=FALSE, legend.text.size=0.7, legend.width=1)+tm_legend(legend.position=c("right", "top"), outside=TRUE) 

```

## Add historical data from Leif's dataset
# Filter by collection - ie. Bohart Collection to see if Robins 1983 paper matches these records
```{r}
Leifdata<-read.csv("./HistoricalBohartData/BBNACalifornia.csv")
## Make sure all is distinct 
Leifdata<-Leifdata %>% distinct(location, date, species, caste, observers, .keep_all=TRUE) 
head(Leifdata)

```


# Assign each one of Leif's datapoints to an Ecoregion using USGS Level III
```{r}
AllYears<-Leifdata %>% select(BBNA.code, species, sex, month, year, longitude, latitude) %>% na.omit()


Leifdata %>% filter(species=="impatiens")
#Convert lat/long data to epsg 5070 to match ecoregion projection in rgdal package
COORDSall<-SpatialPoints(cbind(AllYears$longitude, AllYears$latitude), proj4string=CRS("+proj=longlat"))
coordsall<-spTransform(COORDSall, CRS("+init=epsg:5070"))

#Transform to data frame and add site information 
convertall<-data.frame(coordsall) 
convertallcomb<-cbind(convertall, AllYears) %>% 
  rename(x="coords.x1") %>% 
  rename(y="coords.x2")
head(convertallcomb)

#Convert to sf object to match with ecoregion 
site.sf.all <- st_as_sf(convertallcomb, coords=c("x", "y"), crs=5070) 


#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Allyears_ecoregion<-point.in.poly(site.sf.all, ecoregions) %>% as.data.frame() %>% rename(Ecoregion=NA_L3NAME)


Calibombussites_ecoregions$NA_L3NAME %>% unique()
#Filter so we only have ecoregions that were sampled in 2019
SpeciesEco<-Allyears_ecoregion %>% filter(Ecoregion %in% c("Sierra Nevada", "Coastal Sage", "Coast Range", "Klamath", "Cascades", "Central Basin"))


SpeciesEco<-SpeciesEco[!(is.na(SpeciesEco$species) | SpeciesEco$species==""), ]
SpeciesEco %>% filter(Ecoregion=="Cascades")
FinalEcos<-SpeciesEco %>% group_by(Ecoregion) %>% count(species) %>% mutate(count=1) %>% mutate(EcoRichness=sum(count)) %>% rename("Richness"=n) %>% select(Ecoregion, species, EcoRichness)






```










