---
title: "CaliBombus Spatial"
output: html_document
---

#Load Packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(sf)
library(tmap)
library(sp)
library(spatialEco)
library(rgdal)
library(stringr)


```

#Import data from EPA/USGS and CaliBombus
## Note: USGS is in a projected coordinate system and GPS coordinates are in a geographic coordinate system 
### It is best too use projected coordinate system for geospatial analyses
I used the sf package
Also changed NA_L3Names so they are shorter 
```{r}
#Import ecoregion shape file from EPA/USGS Level III 
ecoregionshape<-st_read("./USGS_ecoregions20/ca_eco_l3.shp") #sf package
#Check coordinate reference system 
st_crs(ecoregionshape) #sf package
# Coordinate reference system is USA_Contiguous_Albers_Equal_Area_Conic_USGS_version
# Datum is North American Datum 1983

##Recode variable names so they are shorter 
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Coast Range' = "Coast Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central Basin and Range' = "Central Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Mojave Basin and Range' = "Mojave Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sierra Nevada' = "Sierra Nevada")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'California Coastal Sage, Chaparral, and Oak Woodlands' = "Coastal Sage")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central California Valley' = "Central Valley")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Klamath Mountains' = "Klamath")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Southern and Baja California Pine-Oak Mountains' = "SoCal Mountains")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Northern Basin and Range' = "Northern Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sonoran Desert' = "Sonoran Desert")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Eastern Cascades Slopes and Foothills' = "Eastern Cascades")

#Condense ecoregion to name and geometry (ie. coordinates)
ecoregions<-ecoregionshape %>% select(NA_L3NAME, geometry)


#Read in site gps coordinates
site<-read.csv("./USGS_ecoregions20/spatialinfofinal.csv") %>% select(Site_Grouping, lon, lat) 

# Make sites into a spatial object
cordSites<-st_as_sf(site, 
                        coords = c("lon", "lat"),
                        crs = st_crs("+proj=longlat"))

#Convert lat/long data to same projection as USGS Ecoregions
sites_Cali19<-st_transform(cordSites, crs=st_crs(ecoregionshape)) %>% rename(site= Site_Grouping)

#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Calibombussites_ecoregions<-point.in.poly(sites_Cali19, ecoregions) %>% as.data.frame()
write.csv(Calibombussites_ecoregions, "./DataFrames/calibombussites_ecoregion.csv")
```
#Make a pretty map 
```{r}
#Map without labels
tm_shape(ecoregions) + tm_style("col_blind")+
  tm_polygons(col="NA_L3NAME", border.col="white", palette="Dark2", title="Ecoregion")+
  tm_shape(sites_Cali19) + tm_dots(size=0.2, col="black")+
 tm_layout(frame=FALSE, legend.text.size=0.7, legend.width=1)+tm_legend(legend.position=c("right", "top"), outside=TRUE) 

# Map with only caliginosus sites
calisites<-site.sf %>% filter(site %in% c("HA", "SC",
                                          "NC1",
                                          "NC2",
                                          "NC3"))

tm_shape(ecoregions) + tm_style("col_blind")+
  tm_polygons(col="NA_L3NAME", border.col="white", palette="Dark2", title="Ecoregion")+
  tm_shape(calisites) + tm_dots(size=0.2, col="black")+
 tm_layout(frame=FALSE, legend.text.size=0.7, legend.width=1)+tm_legend(legend.position=c("right", "top"), outside=TRUE) 



```

## Add historical data from Leif's dataset
# Filter by collection - ie. Bohart Collection to see if Robins 1983 paper matches these records
```{r}
Leifdata<-read.csv("./HistoricalBohartData/BBNACalifornia.csv")
## Make sure all is distinct 
Leifdata<-Leifdata %>% distinct(location, date, species, caste, observers, .keep_all=TRUE) 
head(Leifdata)
Leifdata %>% dplyr::select(Institution) %>% unique()
```
# Select which records we will actually use - based on insititution they are from
```{r}
York<-Leifdata %>% filter(grepl("York", Institution))
nrow(York)
PaulWilliams<-Leifdata %>% filter(grepl("Paul", Institution))
nrow(PaulWilliams)
Ontario<-Leifdata %>% filter(grepl("Ontario", Institution))
Irwin<-Leifdata %>% filter(grepl("Irwin", Institution))
nrow(Irwin)
Ohio<-Leifdata %>% filter(grepl("Ohio", Institution))
Riverside<-Leifdata %>% filter(grepl("Riverside", Institution))
nrow(Riverside)
NC<-Leifdata %>% filter(grepl("Carolina", Institution))
nrow(NC)
Illinois<-Leifdata %>% filter(grepl("Illinois", Institution))
nrow(Illinois)
Yale<-Leifdata %>% filter(grepl("Yale", Institution))
Colorado<-Leifdata %>% filter(grepl("Colorado", Institution))
nrow(Colorado)
CAS<-Leifdata %>% filter(grepl("Academy", Institution))
nrow(CAS)
Penn<-Leifdata %>% filter(grepl("Penn", Institution))
Bohart<-Leifdata %>% filter(grepl("Bohart", Institution))
nrow(Bohart)
American<-Leifdata %>% filter(grepl("AMNH", Institution))
nrow(American)
Cornell<-Leifdata %>% filter(grepl("Cornell", Institution))
nrow(Cornell)
Smithsonian<-Leifdata %>% filter(grepl("Smithsonian", Institution))
nrow(Smithsonian)
USDA<-Leifdata %>% filter(grepl("USDA", Institution))
nrow(USDA)
Snow<-Leifdata %>% filter(grepl("Snow", Institution))
nrow(Snow)
Harvard<-Leifdata %>% filter(grepl("Harvard", Institution))
nrow(Harvard)
Wisconsin<-Leifdata %>% filter(grepl("Wisconsin", Institution))
nrow(Wisconsin)
Field<-Leifdata %>% filter(grepl("Field", Institution))
nrow(Field)
Essig<-Leifdata %>% filter(grepl("Essig", Institution))
nrow(Essig)
LA<-Leifdata %>% filter(grepl("LACM", Institution))
nrow(LA)
UCSD<-Leifdata %>% filter(grepl("Diego", Institution))
nrow(UCSD)
Humboldt<-Leifdata %>% filter(grepl("Humboldt", Institution))
nrow(Humboldt)
Thomson<-Leifdata %>% filter(grepl("Thomson", Institution))
nrow(Thomson)
Florida<-Leifdata %>% filter(grepl("Florida", Institution))
nrow(Florida)
Texas<-Leifdata %>% filter(grepl("Texas", Institution))
nrow(Texas)
Occidental<-Leifdata %>% filter(grepl("Occidental", Institution))
nrow(Occidental)
ECOSUR<-Leifdata %>% filter(grepl("Colegio", Institution))
nrow(ECOSUR)
Bird<-Leifdata %>% filter(grepl("Bird", Institution))
nrow(Bird)
Neal<-Leifdata %>% filter(grepl("N. Williams", Institution))
nrow(Neal)
California<-Leifdata %>% filter(grepl("California State", Institution))
nrow(California)
UCSC<-Leifdata %>% filter(grepl("Santa Cruz", Institution))
nrow(UCSC)

FinalCollect<-rbind(York, PaulWilliams, Ontario, Irwin, Ohio, Riverside, NC, 
                    Illinois, Yale, Colorado, CAS, Penn, Bohart, American, Cornell, Smithsonian,
                    USDA, Snow, Harvard, Wisconsin, Field, Essig, LA, UCSD, Humboldt, Thomson, 
                    Florida, Texas, Occidental, ECOSUR, Bird, Neal, California, UCSC)
print(paste("We used", nrow(FinalCollect), "records for the final analysis"))

```


# Assign each one of Leif's datapoints to an Ecoregion using USGS Level III
```{r}
AllYears<-FinalCollect %>% select(BBNA.code, species, sex, month, year, longitude, latitude) %>% na.omit()


Leifdata %>% filter(species=="impatiens")
#Convert lat/long data to epsg 5070 to match ecoregion projection in rgdal package
COORDSall<-SpatialPoints(cbind(AllYears$longitude, AllYears$latitude), proj4string=CRS("+proj=longlat"))
coordsall<-spTransform(COORDSall, CRS("+init=epsg:5070"))

#Transform to data frame and add site information 
convertall<-data.frame(coordsall) 
convertallcomb<-cbind(convertall, AllYears) %>% 
  rename(x="coords.x1") %>% 
  rename(y="coords.x2")
head(convertallcomb)

#Convert to sf object to match with ecoregion 
site.sf.all <- st_as_sf(convertallcomb, coords=c("x", "y"), crs=5070) 

#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Allyears_ecoregion<-point.in.poly(site.sf.all, ecoregions) %>% as.data.frame() %>% rename(Ecoregion=NA_L3NAME)


Calibombussites_ecoregions$NA_L3NAME %>% unique()
#Filter so we only have ecoregions that were sampled in 2019
SpeciesEco<-Allyears_ecoregion %>% filter(Ecoregion %in% c("Sierra Nevada", "Coastal Sage", "Coast Range", "Klamath", "Cascades", "Central Basin"))


SpeciesEco<-SpeciesEco[!(is.na(SpeciesEco$species) | SpeciesEco$species==""), ]
SpeciesEco %>% filter(Ecoregion=="Cascades")
FinalEcos<-SpeciesEco %>% group_by(Ecoregion) %>% count(species) %>% mutate(count=1) %>% mutate(EcoRichness=sum(count)) %>% rename("Richness"=n) %>% select(Ecoregion, species, EcoRichness)


FinalEcos %>% filter(Ecoregion=="Sierra Nevada")



```










