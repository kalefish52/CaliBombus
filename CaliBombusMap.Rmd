---
title: "CaliBombus Spatial"
output:
  html_document: default
  pdf_document: default
---

#Load Packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(sf)
library(tmap)
library(sp)
library(spatialEco)
library(rgdal)
library(stringr)


```

#Import data from EPA/USGS and CaliBombus
## Note: USGS is in a projected coordinate system and GPS coordinates are in a geographic coordinate system 

I used the sf package
Also changed NA_L3Names so they are shorter 
```{r, include=FALSE}
#Import ecoregion shape file from EPA/USGS Level III 
ecoregionshape<-st_read("./USGS_ecoregions20/ca_eco_l3.shp") #sf package
#Check coordinate reference system 
st_crs(ecoregionshape) #sf package
# Coordinate reference system is USA_Contiguous_Albers_Equal_Area_Conic_USGS_version
# Datum is North American Datum 1983

##Recode variable names so they are shorter 
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Coast Range' = "Coast Range")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central Basin and Range' = "Central Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Mojave Basin and Range' = "Mojave Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sierra Nevada' = "Sierra Nevada")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'California Coastal Sage, Chaparral, and Oak Woodlands' = "Coastal Sage")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Central California Valley' = "Central Valley")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Klamath Mountains' = "Klamath")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Southern and Baja California Pine-Oak Mountains' = "SoCal Mountains")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Northern Basin and Range' = "Northern Basin")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Sonoran Desert' = "Sonoran Desert")
ecoregionshape$NA_L3NAME<-recode(ecoregionshape$NA_L3NAME, 'Eastern Cascades Slopes and Foothills' = "Eastern Cascades")

#Condense ecoregion to name and geometry (ie. coordinates)
ecoregions<-ecoregionshape %>% select(NA_L3NAME, geometry)


#Read in site gps coordinates
site<-read.csv("./USGS_ecoregions20/spatialinfofinal.csv") %>% select(Site_Grouping, lon, lat) 

# Make sites into a spatial object
cordSites<-st_as_sf(site, 
                        coords = c("lon", "lat"),
                        crs = st_crs("+proj=longlat"))

#Convert lat/long data to same projection as USGS Ecoregions
sites_Cali19<-st_transform(cordSites, crs=st_crs(ecoregionshape)) %>% rename(site= Site_Grouping)

#Overlay gps points with ecoregion polygons to see which sites are in which ecoregions
Calibombussites_ecoregions<-point.in.poly(sites_Cali19, ecoregions) %>% as.data.frame()
write.csv(Calibombussites_ecoregions, "./DataFrames/calibombussites_ecoregion.csv")
```
#Make a pretty map 
```{r}
#Map without labels
tm_shape(ecoregions) + tm_style("col_blind")+
  tm_polygons(col="NA_L3NAME", border.col="white", palette="Dark2", title="Ecoregion")+
  tm_shape(sites_Cali19) + tm_dots(size=0.2, col="black")+
 tm_layout(frame=FALSE, legend.text.size=0.7, legend.width=1)+tm_legend(legend.position=c("right", "top"), outside=TRUE) 
```

## Add historical data from Leif's dataset

```{r, include=FALSE}
Leifdata<-read.csv("./HistoricalBohartData/BBNACalifornia.csv")
## Make sure all is distinct 
Leifdata<-Leifdata %>% distinct(location, date, species, caste, observers, .keep_all=TRUE) 
Leifdata %>% dplyr::select(Institution) %>% unique()
```
# Select which records we will actually use - based on insititution they are from
```{r, include=FALSE}
York<-Leifdata %>% filter(grepl("York", Institution))
nrow(York)
PaulWilliams<-Leifdata %>% filter(grepl("Paul", Institution))
nrow(PaulWilliams)
Ontario<-Leifdata %>% filter(grepl("Ontario", Institution))
Irwin<-Leifdata %>% filter(grepl("Irwin", Institution))
nrow(Irwin)
Ohio<-Leifdata %>% filter(grepl("Ohio", Institution))
Riverside<-Leifdata %>% filter(grepl("Riverside", Institution))
nrow(Riverside)
NC<-Leifdata %>% filter(grepl("Carolina", Institution))
nrow(NC)
Illinois<-Leifdata %>% filter(grepl("Illinois", Institution))
nrow(Illinois)
Yale<-Leifdata %>% filter(grepl("Yale", Institution))
Colorado<-Leifdata %>% filter(grepl("Colorado", Institution))
nrow(Colorado)
CAS<-Leifdata %>% filter(grepl("Academy", Institution))
nrow(CAS)
Penn<-Leifdata %>% filter(grepl("Penn", Institution))
Bohart<-Leifdata %>% filter(grepl("Bohart", Institution))
nrow(Bohart)
American<-Leifdata %>% filter(grepl("AMNH", Institution))
nrow(American)
Cornell<-Leifdata %>% filter(grepl("Cornell", Institution))
nrow(Cornell)
Smithsonian<-Leifdata %>% filter(grepl("Smithsonian", Institution))
nrow(Smithsonian)
USDA<-Leifdata %>% filter(grepl("USDA", Institution))
nrow(USDA)
Snow<-Leifdata %>% filter(grepl("Snow", Institution))
nrow(Snow)
Harvard<-Leifdata %>% filter(grepl("Harvard", Institution))
nrow(Harvard)
Wisconsin<-Leifdata %>% filter(grepl("Wisconsin", Institution))
nrow(Wisconsin)
Field<-Leifdata %>% filter(grepl("Field", Institution))
nrow(Field)
Essig<-Leifdata %>% filter(grepl("Essig", Institution))
nrow(Essig)
LA<-Leifdata %>% filter(grepl("LACM", Institution))
nrow(LA)
UCSD<-Leifdata %>% filter(grepl("Diego", Institution))
nrow(UCSD)
Humboldt<-Leifdata %>% filter(grepl("Humboldt", Institution))
nrow(Humboldt)
Thomson<-Leifdata %>% filter(grepl("Thomson", Institution))
nrow(Thomson)
Florida<-Leifdata %>% filter(grepl("Florida", Institution))
nrow(Florida)
Texas<-Leifdata %>% filter(grepl("Texas", Institution))
nrow(Texas)
Occidental<-Leifdata %>% filter(grepl("Occidental", Institution))
nrow(Occidental)
ECOSUR<-Leifdata %>% filter(grepl("Colegio", Institution))
nrow(ECOSUR)
Bird<-Leifdata %>% filter(grepl("Bird", Institution))
nrow(Bird)
Neal<-Leifdata %>% filter(grepl("N. Williams", Institution))
nrow(Neal)
California<-Leifdata %>% filter(grepl("California State", Institution))
nrow(California)
UCSC<-Leifdata %>% filter(grepl("Santa Cruz", Institution))
nrow(UCSC)

FinalCollect<-rbind(York, PaulWilliams, Ontario, Irwin, Ohio, Riverside, NC, 
                    Illinois, Yale, Colorado, CAS, Penn, Bohart, American, Cornell, Smithsonian,
                    USDA, Snow, Harvard, Wisconsin, Field, Essig, LA, UCSD, Humboldt, Thomson, 
                    Florida, Texas, Occidental, ECOSUR, Bird, Neal, California, UCSC)
print(paste("We used", nrow(FinalCollect), "records for the final analysis"))

```


# Assign each one of Leif's datapoints to an Ecoregion using USGS Level III
```{r, include=FALSE}
HistoricalBumbles<-FinalCollect %>% select(BBNA.code, species, sex, month, year, longitude, latitude) %>% na.omit()

# Make historical records into a spatial object
cordHist<-st_as_sf(HistoricalBumbles, 
                        coords = c("longitude", "latitude"),
                        crs = st_crs("+proj=longlat"))

#Convert lat/long data to same projection as USGS Ecoregions
HistBumblesSp<-st_transform(cordHist, crs=st_crs(ecoregionshape)) 
# Find species in each ecoregion 
Allyears_ecoregion<-point.in.poly(HistBumblesSp, ecoregions) %>% as.data.frame() %>% rename(Ecoregion=NA_L3NAME)


#Filter so we only have ecoregions that were sampled in 2019
SpeciesEco<-Allyears_ecoregion %>% filter(Ecoregion %in% c("Sierra Nevada", "Coastal Sage", "Coast Range", "Klamath", "Cascades", "Central Basin"))


SpeciesEco<-SpeciesEco[!(is.na(SpeciesEco$species) | SpeciesEco$species==""), ]
SpeciesEco %>% filter(Ecoregion=="Cascades")

# How many species were historically in each ecoregion? 
FinalEcos<-SpeciesEco %>% group_by(Ecoregion) %>% count(species) %>% mutate(count=1) %>% mutate(EcoRichness=sum(count)) %>% rename("Richness"=n) %>% select(Ecoregion, species, EcoRichness)


FinalEcos %>% filter(Ecoregion=="Sierra Nevada")
```

# Comparison between historical and modern dataset
Draw 5, 10 and 20k radii around each site and see which historical records are there.
```{r}
#Make shapefiles with 5, 10, 20km  radii around each site 
ModSites5k <- st_buffer(sites_Cali19, dist = 5000)
ModSites10k <- st_buffer(sites_Cali19, dist = 10000)
ModSites20k <- st_buffer(sites_Cali19, dist = 20000)

#See how many bees were present historically in these radii
## Within 5k 
BeesatSites5kHist<-point.in.poly(HistBumblesSp, ModSites5k) %>% as.data.frame() 
# Remove site nas because the bee records are not in those site radii
BeesatSites5kHistf<-BeesatSites5kHist %>% filter(site != "NA")
print(paste("There are", nrow(BeesatSites5kHistf), "bees found historically within 5 km of all of our sites"))
min(BeesatSites5kHistf$year)
max(BeesatSites5kHistf$year)

## Within 10k 
BeesatSites5kHist<-point.in.poly(HistBumblesSp, ModSites10k) %>% as.data.frame() 
# Remove site nas because the bee records are not in those site radii
BeesatSites10kHistf<-BeesatSites5kHist %>% filter(site != "NA")
print(paste("There are", nrow(BeesatSites10kHistf), "bees found historically within 10 km of all of our sites"))

min(BeesatSites10kHistf$year)
max(BeesatSites10kHistf$year)

## Within 20k 
BeesatSites20kHist<-point.in.poly(HistBumblesSp, ModSites20k) %>% as.data.frame() 
# Remove site nas because the bee records are not in those site radii
BeesatSites20kHistf<-BeesatSites20kHist %>% filter(site != "NA")
print(paste("There are", nrow(BeesatSites20kHistf), "bees found historically within 20 km of all of our sites"))
min(BeesatSites20kHistf$year)
max(BeesatSites20kHistf$year)
```

## 10k Separate historical pre and post 2000 
```{r}
# Past 10 years (only have records up until 2011)
Post2000_10k<-BeesatSites10kHistf %>% filter(year >= 2000)
nrow(Post2000_10k)

# 10 years prior to 2000 (1989-2000)
Pre2000_10k<-BeesatSites10kHistf %>% filter(year < 2000 & year > 1989)
nrow(Pre2000_10k)

# Abundance (# records) Post
head(Post2000_10k)
samples_10K_Post2000<-Post2000_10k %>% group_by(site) %>% mutate(count=1) %>% 
  mutate(abundance=sum(count)) %>% select(site, abundance) %>% unique() %>% mutate(years="2000-2011")

# Abundance (# records) Pre
samples_10K_Pre2000<-Pre2000_10k %>% group_by(site) %>% mutate(count=1) %>% 
  mutate(abundance=sum(count)) %>% select(site, abundance) %>% unique() %>% mutate(years="1989-1999")

# Combine pre and post 
AbundanceHist10<-rbind(samples_10K_Post2000, samples_10K_Pre2000)

AbundGraph10<-ggplot(AbundanceHist10, aes(x=site, y=abundance, fill=years)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Number of Records within 10km of each Site")+ theme(axis.text.x  = element_text(angle=90))
AbundGraph10

# Richness Post
head(Post2000_10k)
samplesrich_10K_Post2000<-Post2000_10k %>% group_by(site, species) %>% mutate(count=1) %>% 
  mutate(speciesabund=sum(count)) %>% select(site, speciesabund) %>% unique() %>% ungroup() %>% group_by(site) %>% mutate(count=1) %>% mutate(richness=sum(count)) %>% select(site, richness) %>% unique() %>% mutate(years="2000-2011")

# Richness Pre 
samplesrich_10K_Pre2000<-Pre2000_10k %>% group_by(site, species) %>% mutate(count=1) %>% 
  mutate(speciesabund=sum(count)) %>% select(site, speciesabund) %>% unique() %>% ungroup() %>% group_by(site) %>% mutate(count=1) %>% mutate(richness=sum(count)) %>% select(site, species, richness) %>% mutate(years="1989-1999")
samplesrich_10K_Pre2000

# Combine 
RichnessHist10<-rbind(samplesrich_10K_Post2000, samplesrich_10K_Pre2000)

#Graph
RichGraph10<-ggplot(RichnessHist10, aes(x=site, y=richness, fill=years)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Richness of Areas within 10km of each Site")+ theme(axis.text.x  = element_text(angle=90))
RichGraph10
```

## 20k Separate historical pre and post 2000 
```{r}
# Past 10 years (only have records up until 2011)
Post2000_20k<-BeesatSites20kHistf %>% filter(year >= 2000)
nrow(Post2000_20k)

# 10 years prior to 2000 (1989-2000)
Pre2000_20k<-BeesatSites20kHistf %>% filter(year < 2000 & year > 1989)
nrow(Pre2000_20k)

# Abundance (# records) Post
samples_20K_Post2000<-Post2000_20k %>% group_by(site) %>% mutate(count=1) %>% 
  mutate(abundance=sum(count)) %>% select(site, abundance) %>% unique() %>% mutate(years="2000-2011")

# Abundance (# records) Pre
samples_20K_Pre2000<-Pre2000_20k %>% group_by(site) %>% mutate(count=1) %>% 
  mutate(abundance=sum(count)) %>% select(site, abundance) %>% unique() %>% mutate(years="1989-1999")

# Combine pre and post 
AbundanceHist20<-rbind(samples_20K_Post2000, samples_20K_Pre2000)

AbundGraph20<-ggplot(AbundanceHist20, aes(x=site, y=abundance, fill=years)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Number of Records within 20km of each Site")+ theme(axis.text.x  = element_text(angle=90))
AbundGraph20

# Richness Post
head(Post2000_20k)
samplesrich_20K_Post2000<-Post2000_20k %>% group_by(site, species) %>% mutate(count=1) %>% 
  mutate(speciesabund=sum(count)) %>% select(site, speciesabund) %>% unique() %>% ungroup() %>% group_by(site) %>% mutate(count=1) %>% mutate(richness=sum(count)) %>% select(site, richness) %>% unique() %>% mutate(years="2000-2011")

# Richness Pre 
samplesrich_20K_Pre2000<-Pre2000_20k %>% group_by(site, species) %>% mutate(count=1) %>% 
  mutate(speciesabund=sum(count)) %>% select(site, speciesabund) %>% unique() %>% ungroup() %>% group_by(site) %>% mutate(count=1) %>% mutate(richness=sum(count)) %>% select(site, species, richness) %>% mutate(years="1989-1999")

# Combine 
RichnessHist20<-rbind(samplesrich_20K_Post2000, samplesrich_20K_Pre2000)

#Graph
RichGraph20<-ggplot(RichnessHist20, aes(x=site, y=richness, fill=years)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Richness of Areas within 20km of each Site")+ theme(axis.text.x  = element_text(angle=90))
RichGraph20
```

## 10K Pre 1983
```{r}
Pre1983_10k<-BeesatSites10kHistf %>% filter(year <= 1983)
nrow(Pre1983_10k)
# Abundance at each site
samples_10K_Pre1983<-Pre1983_10k %>% group_by(site) %>% mutate(count=1) %>% 
  mutate(abundance=sum(count)) %>% select(site, abundance) %>% unique() 

AbundGraph83<-ggplot(samples_10K_Pre1983, aes(x=site, y=abundance)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Number of Records within 10km of each Site Collected Before 1983")+ theme(axis.text.x  = element_text(angle=90))
AbundGraph83

#richness 
samplesrich_10K_Pre1983<-Pre1983_10k %>% group_by(site, species) %>% mutate(count=1) %>% 
  mutate(speciesabund=sum(count)) %>% select(site, speciesabund) %>% unique() %>% ungroup() %>% group_by(site) %>% mutate(count=1) %>% mutate(richness=sum(count)) %>% select(site, species, richness) 
samplesrich_10K_Pre1983

RichGraph83<-ggplot(samplesrich_10K_Pre1983, aes(x=site, y=richness)) + geom_bar(stat="identity", position=position_dodge()) +ggtitle("Richness of Areas within 10km of each Site Collected Before 1983")+ theme(axis.text.x  = element_text(angle=90))
RichGraph83
```









