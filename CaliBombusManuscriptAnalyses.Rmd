---
title: "CaliBombus"
author: "Kaleigh Fisher"
date: "14 July 2020"
output:
  html_document: default
  pdf_document: default
---
#Load Necessary Packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(vegan)
library(janitor)
library(gtsummary)
library(tibble)
library(iNEXT)
library(ggrepel)
library(ggpubr)

```

#Load all data and filter
##Filter out non-Bombus samples
##Select relevant data columns for downstream analyses 
```{r, include=FALSE}
data<-read.csv("../CaliBombus/CaliBombus_inventory_main.csv")

head(data)
# Filter out non-bees and select relevant columns 
dataALL <- data %>% filter(!Verified.Bee.species.ID %in% c("", "NA - Andrena?", "NA - Anthophorid", "NA - Anthophorid?", "NA - fly (bumble mimic)", "NA - nonBombus", "NA - Osmia?", "NA - robber fly", "NA - Xylocopa")) %>% select(Bee.Unique.ID, Date_comb, Date_reformat, Locality_reformat, Latitude, Longitude, Site_Grouping, Ecoregion, Elevation_ft, County, Collector, Verified.Bee.species.ID, sex.caste, Floral.association..field.ID.)
head(dataALL)

```

# Filter Sites
## Combine dates that are within 3 days of each other -  This was done in inventory manually - do not run 
```{r, include=FALSE}

#Combine sampling times for sites that were collected within 3 days of each other - this was done manually 

#Change date format so we can do math
head(dataALL)
dates<-str_remove(dataALL$Date_comb, "-")
dates<-str_remove(dates, "-")
dataALL$Date<-as.Date(dates, "%d%b%Y")
#Make column with number of days between sampling dates 
dateRANGE <-dataALL %>% group_by(Site_Grouping) %>% mutate(range=(max(Date)-min(Date)))

#Find all sites with less than three days to combine - do not rerun because changed manually in CaliBombus_inventor_main.csv file 
#dateRANGE %>% filter(range != 0 & range <= 3) %>% unique() %>% select(Site_Grouping, Date, range) %>% unique()

dataALL %>% select(Locality_reformat, Ecoregion) %>% unique()

## Changed dates for SC, MK, WM to earliest collection date to combine manually in excel as Date_comb
## also edited verified species ID in Excel to change "tent. vosi" to "vosnesenskii"
```

## Filter based on sampling time and date 
```{r, echo=FALSE}
## Filter any data we'll want to exclude based on site/time - 
# Chose one time per site based on which timepoint had greatest abundance
  ## Oakhurst (OA: 104 in May, exclude June)
  ## North Fork (NF: 98 in June, exclude may)
  ## Wawona (WA: 84 in June, exclude July)
dataFinal<-dataALL %>% filter(Site_Grouping != "misc") %>% filter(!Date_comb %in% c("3-Jun-19","7-May-19","6-Jul-19")) %>% select(Date_comb, Site_Grouping, Ecoregion, Verified.Bee.species.ID, sex.caste, Latitude, Longitude, Elevation_ft, Floral.association..field.ID.) 

#Combine californicus and fervidus as one species, according to Leif's characterization
dataFinal<-dataFinal %>% 
  mutate(Verified.Bee.species.ID=recode(Verified.Bee.species.ID, californicus="fervidus")) %>% mutate(sex.caste=recode(sex.caste, female="worker")) 
```

# Add USGS Ecoregion Info to each site 
```{r, include=FALSE }
Calibombussites_ecoregions<-read.csv("./DataFrames/calibombussites_ecoregion.csv")
#Remove previously assigned ecoregion from dataFinal
dataeco<-dataFinal %>% select(!Ecoregion)
head(Calibombussites_ecoregions) #from CaliSpatial rmd
Ecoregions<-Calibombussites_ecoregions %>% rename(Site_Grouping=site) %>% rename(Ecoregion.1=NA_L3NAME)
head(Ecoregions)

#Join USGS ecoregion info with existing dataframe
dataFINAL<-left_join(dataFinal, Ecoregions, by="Site_Grouping")
head(dataFINAL)
write.csv(dataFINAL, "./DataFrames/dataFINAL.csv")
```

# Diversity Metrics
## Site Richness/Abundance 
```{r}
# Calculate abundance and richness for each site
speciesCOUNT<-dataFINAL %>% group_by(Site_Grouping) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(SpeciesRichness=sum(count)) %>% rename("SpeciesAbundance"=n) 

#Add Total Abundance column(total number of bombus/site)
speciesCOUNT<-speciesCOUNT %>% mutate(TotalAbundance=sum(SpeciesAbundance))

#Merge richness/abundance info with site characteristics by Site_Grouping
#Use this data frame for sampling time specific questions
dataDiv<-left_join(dataFINAL, speciesCOUNT, by=c("Site_Grouping", 
                                              "Verified.Bee.species.ID"))
dataDiv %>% select(Ecoregion.1, Site_Grouping, SpeciesRichness) %>% unique() %>% arrange(desc(SpeciesRichness))

#Visualize abundance at final sites 
FinalSites <- dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique()
FinalSites %>% ggplot(aes(x=Site_Grouping, y=TotalAbundance))+
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

print(paste("The minimum number of bees at a site is", min(FinalSites$TotalAbundance), "and the the max number of bees at a site is", max(FinalSites$TotalAbundance)))
```


## Species summary - How many specific individuals (species) do we have? 
```{r}
caliginosus<-dataDiv %>% select(Site_Grouping, Ecoregion.1, SpeciesAbundance, Verified.Bee.species.ID, TotalAbundance) %>% unique() %>% filter(Verified.Bee.species.ID=="caliginosus") %>% mutate(PCal=((SpeciesAbundance/TotalAbundance)*100))
caliginosus
totalcollected<-caliginosus %>% mutate(totalcal=sum(SpeciesAbundance))
totalcollected
print(paste("We collected 36 caliginosus across all sites" ))

ggplot(caliginosus, aes(x=Site_Grouping, y=PCal)) + geom_bar(stat="identity") + ggtitle("Percentage caliginosus at each site")

insularis<-dataDiv%>% select(Site_Grouping, Ecoregion.1, SpeciesAbundance, Verified.Bee.species.ID, TotalAbundance) %>% unique() %>% filter(Site_Grouping=="insularis")

flavidus<-dataDiv %>% select(Site_Grouping, Ecoregion.1, SpeciesAbundance, Verified.Bee.species.ID, TotalAbundance) %>% unique() %>% filter(Verified.Bee.species.ID=="flavidus")
flavidus

mountswhat<-dataDiv %>% filter(Ecoregion.1 %in% c("Klamath", "Sierra Nevada", "Cascades")) %>% select(Verified.Bee.species.ID) %>% unique()

coastswhat<-dataDiv %>% filter(Ecoregion.1 %in% c("Coastal Sage", "Coast Range")) %>% select(Verified.Bee.species.ID) %>% unique()

mountswhat
coastswhat

CB<-dataDiv %>% filter(Ecoregion.1 == "Central Basin") %>% select(Verified.Bee.species.ID) %>% unique()
CB
```

## Descriptive Information for Mansucript- Site and Ecoregion Characteristics and Information 
```{r, echo=FALSE}
#What is the average number of bees per site? 
AvgMeanSite<-dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(mean=mean(TotalAbundance))

SDSite<-dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(sd=sd(TotalAbundance))
SDSite/sqrt(17)

sdMeanSite<-dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(SD=sd(TotalAbundance))
sdMeanSite/sqrt(17) # Standard error
print(paste("We sampled a mean of", AvgMeanSite, "bees per site with a standard deviation of", sdMeanSite))
#What is the min/max number of bees per site? 
MinSite<-dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(Min=min(TotalAbundance))
MinSite
MaxSite<-dataDiv %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(Min=max(TotalAbundance))
MaxSite

# Total Richness per Site
head(dataDiv)
FinalEcos<-dataDiv %>% select(Ecoregion.1, Verified.Bee.species.ID) %>% group_by(Ecoregion.1) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(EcoRichness=sum(count)) %>% rename("Richness"=n) %>% select(!c(count,Richness))

FinalEcos

#What is the average richness per site?
AvgRichSite<-dataDiv %>% select(Site_Grouping, SpeciesRichness) %>% unique() %>% summarize(mean=mean(SpeciesRichness))
sdRichSite<-dataDiv %>% select(Site_Grouping, SpeciesRichness) %>% unique() %>% summarize(SD=sd(SpeciesRichness))
print(paste("We sampled a mean of", AvgRichSite, "bee richness per site with a standard deviation of", sdRichSite))

#How many males did we collect total relative to females across all sites? 
TotalSexCollected<-dataDiv %>% select(sex.caste) %>% mutate(count=1) %>% group_by(sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, total)
TotalSexCollected %>%mutate(RelativeAbundance=(total/sum(TotalSexCollected$total))*100)
TotalSexCollected
ggplot(TotalSexCollected, aes(x=sex.caste, y=total)) +geom_bar(stat="identity")

#How many males did we collect per site? 
SiteSex<-dataDiv %>% select(sex.caste, Site_Grouping) %>% mutate(count=1) %>%  group_by(Site_Grouping, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Site_Grouping, total) 
ggplot(SiteSex, aes(x=Site_Grouping, y=total, fill=sex.caste)) +geom_bar(stat="identity")

ggsave("./Figures/CasteSite.png")

#How many males did we collect per ecoregion? 
SiteEcoregion<-dataDiv %>% select(sex.caste, Ecoregion.1) %>% mutate(count=1) %>%  group_by(Ecoregion.1, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Ecoregion.1, total) 
SiteEcoregion %>% group_by(Ecoregion.1) %>% mutate(totinds=sum(total)) %>% ungroup() %>%  
  mutate(propcaste=total/totinds)


ggplot(SiteEcoregion, aes(x=Ecoregion.1, y=total, fill=sex.caste)) +geom_bar(stat="identity")+xlab("Ecoregion")+ylab("Number Bees Collected")
ggsave("CasteRatios.png", dpi=600)

ggsave("./Figures/CasteEcoregion.png")
```
## Supplementary Table 1 
```{r}
dataDiv
SuppTable<-dataDiv %>% select(Date_comb, 
                                Site_Grouping,
                                Verified.Bee.species.ID, 
                                sex.caste, 
                                Ecoregion.1,
                                Floral.association..field.ID.) %>% 
  rename("Date Collected"=Date_comb) %>% 
  rename("Site"=Site_Grouping) %>% 
  rename("Ecoregion"=Ecoregion.1)%>% 
  rename("Floral Assocation"=Floral.association..field.ID.) %>% 
  rename("Caste"=sex.caste) %>% 
  rename("Species"=Verified.Bee.species.ID)
 
write.csv(SuppTable, "./Tables/SuppTable1.csv")
```

## Table 1 Information
How many sites and regions had which species?? 
Includes the number of sites and ecoregions with which species 
Treating all individuals collected equally (ie. males=females=queens)
```{r, echo=FALSE}
#Remove sex.caste information and flooral association info
head(dataDiv)
TotalBreakdown <- dataDiv %>% select(!c(sex.caste, Latitude, Longitude, Elevation_ft, Floral.association..field.ID., X, coords.x1, coords.x2, 
                                        count))
#Number of ecoregions for each species
EcoregionNum<-dataDiv %>% select(Ecoregion.1, Verified.Bee.species.ID) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(count=1) %>% 
  mutate(ecoregionnum=sum(count)) %>% select(Verified.Bee.species.ID, ecoregionnum) %>% unique()
EcoregionNum

#Number of sites for each species
SiteNum<-dataDiv %>% select(Verified.Bee.species.ID, Site_Grouping) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(count=1) %>% 
  mutate(Sitenum=sum(count)) %>% select(Verified.Bee.species.ID, Sitenum) %>% unique()
SiteNum

#Total number of individuals for each species 
Totalspecies<-dataDiv %>% select(Verified.Bee.species.ID, SpeciesAbundance, Site_Grouping) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(totalspeciesabundance=sum(SpeciesAbundance)) %>% select(Verified.Bee.species.ID, totalspeciesabundance) %>% unique()
Totalspecies

SummComm<-left_join(SiteNum, EcoregionNum, by="Verified.Bee.species.ID")
head(SummComm)
SummComm<-SummComm %>% rename(Number_of_Sites=Sitenum) %>% rename(Number_of_Ecoregions=ecoregionnum) 
CommunityInfo<-left_join(SummComm, Totalspecies, by="Verified.Bee.species.ID")
Finaldescript<-CommunityInfo %>% 
  mutate(Percentage=(totalspeciesabundance/(sum(CommunityInfo$totalspeciesabundance))*100))
Finaldescript
write.csv(Finaldescript, file="./Tables/SpeciesperSiteEcoregion.csv")
```

## Ecoregion Richness/Abundance
Use AllSpp for all diversity analyses 
```{r, echo=FALSE}
head(TotalBreakdown)
##Ecoregion level numbers
EcoregionData<-TotalBreakdown %>% unique() %>%select(Ecoregion.1, Verified.Bee.species.ID, SpeciesAbundance) %>% group_by(Ecoregion.1, Verified.Bee.species.ID) %>% mutate(EcoAbund=sum(SpeciesAbundance)) %>% select(!SpeciesAbundance) %>% unique()

EcoregionData %>% arrange(Ecoregion.1)
EcoRich<-EcoregionData %>% select(!EcoAbund) %>% group_by(Ecoregion.1) %>% mutate(count=1) %>% mutate(EcoRich=sum(count)) %>% select(!c(count, Verified.Bee.species.ID)) %>% unique()

EcoSpp<-EcoregionData %>% pivot_wider(names_from=Verified.Bee.species.ID, values_from=EcoAbund)
EcoSpp <- EcoSpp %>% replace(is.na(.), 0)

TotalEco<-left_join(EcoregionData, EcoRich, by="Ecoregion.1")

```

# Transform data - diversity compatible
```{r}
AllSpp<-TotalBreakdown %>% unique() %>% pivot_wider(names_from = Verified.Bee.species.ID, values_from = SpeciesAbundance) %>% arrange(Site_Grouping)
#Replace NAs with 0 
AllSpp <- AllSpp %>% replace(is.na(.), 0)
```


# NMDS - see if species change based on Ecoregion
## Based on species counts 
We did not find any significant differences in community composition between ecoregions
```{r, width = 5, height = 4, dpi=600}
# Change species names to abbreviations so graphs look nicer 
names(AllSpp)
#AllSpp<-AllSpp %>% rename(
  #vos=vosnesenskii,
 # mel=melanopygus,
 # van=vandykei,
  #fer=fervidus,
  #cal=caliginosus,
  #fld=flavidus,
  #flf=flavifrons,
  #ruf=rufocinctus,
  #ins=insularis,
  #bif=bifarius,
 # hun=huntii,
 # kir=kirbiellus,
 # syl=sylvicola,
 # cen=centralis,
 # mix=mixtus,
 # gri=griseocollis,
 # app=appositus
#)


# Convert data into community matrix sith species as columns and communities (sites) as rows - remove all columns except for species columns 
comm_matrix<-AllSpp[,7:ncol(AllSpp)] %>% as.matrix()
set.seed(123456)
NMDS=metaMDS(comm_matrix, k=2, distance="bray") 
stressplot(NMDS)
NMDS #Stress ok 

#Get data scores and make new dataframe with site, ecoregion and collection date information
data.scores<-as.data.frame(scores(NMDS))
data.scores$date <- AllSpp$Date_comb
data.scores$Site <-AllSpp$Site_Grouping
data.scores$Ecoregion <-AllSpp$Ecoregion.1


#Gets NMDS info for each behavior
species.scores<-as.data.frame(scores(NMDS, "species"))
species.scores$species<-rownames(species.scores)

## Anosim - are communities different by ecoregion
ano = anosim(comm_matrix, data.scores$Ecoregion, distance = "bray", permutations = 9999)
ano
#No significant differences between ecoregions in community composition

cols<-c("Cascades"="#542788", 
        "Sierra Nevada"="#f1a340", 
        "Central Basin"="#5ab4ac", 
        "Klamath"="#4d9221", 
        "Coast Range"="#c51b7d", 
        "Coastal Sage"="#2166ac")


NMDSplot<-ggplot() + 
  geom_point(data=data.scores, aes(x=NMDS1, y=NMDS2, colour=Ecoregion), size=1)+
  geom_text(data=species.scores, aes(x=NMDS1, y=NMDS2, label=species), size=2.5, position=position_jitter(width=3, height=5))+
  scale_colour_manual(values=cols)+
  scale_x_continuous(limits = c(-5.2, 5.2)) +
  theme_bw()+scale_y_continuous(limits=c(-5.2,5.2)) 

NMDSplot
ggsave("./Figures/NMDS.png", width=8, height=7, dpi=600)

```

# NMDS - presence/absence 
```{r}
#Make presence/absence matrix 
pamat<-AllSpp[,7:ncol(AllSpp)] 
pamat[pamat>0]<-1

# Run NMDS with pamat
set.seed(123456)
NMDS=metaMDS(pamat, k=2, distance="bray") 
stressplot(NMDS)
NMDS #Stress ok 

#Get data scores and make new dataframe with site, ecoregion and collection date information
data.scores<-as.data.frame(scores(NMDS))
data.scores$date <- AllSpp$Date_comb
data.scores$Site <-AllSpp$Site_Grouping
data.scores$Ecoregion <-AllSpp$Ecoregion.1


#Gets NMDS info for each behavior
species.scores<-as.data.frame(scores(NMDS, "species"))
species.scores$species<-rownames(species.scores)
data.scores
## Anosim - are communities different by ecoregion
ano = anosim(pamat, data.scores$Ecoregion, distance = "bray", permutations = 9999)
ano

boops<-data.scores %>% mutate(category=case_when(
  Ecoregion=="Klamath" ~ "mountain",
  Ecoregion=="Sierra Nevada" ~ "mountain",
  Ecoregion=="Cascades" ~ "mountain",
  Ecoregion=="Coastal Sage" ~ "coast", 
  Ecoregion=="Coast Range" ~ "coast", 
  Ecoregion=="Central Basin" ~ "coast"
))

boops
anotwo = anosim(pamat, boops$category, distance = "bray", permutations = 9999)
anotwo


# Only look at mountain groups - are there differences within this group? Nope
mounts<-AllSpp %>% filter(Ecoregion.1 %in% c("Klamath", 
                           "Sierra Nevada",
                           "Cascades"))

mountsm<-mounts[,7:ncol(mounts)] 
mountsm[mountsm>0]<-1

mountsinfo<-boops %>% filter(category=="mountain")
anomount = anosim(mountsm, mountsinfo$Ecoregion, distance="bray", permutations = 9999)
anomount

# Only look at coast groups - are there differences within this group? 
coasts<-AllSpp %>% filter(Ecoregion.1 %in% c("Coastal Sage", 
                           "Coast Range",
                           "Central Basin"))

coastsm<-coasts[,7:ncol(coasts)] 
coastsm[coastsm>0]<-1

coastsinfo<-boops %>% filter(category=="coast")
anoco = anosim(coastsm, coastsinfo$Ecoregion, distance="bray", permutations = 9999)
anoco

## Test with anosim whether central basin is different from Coast Range and Coastal Sage -- its not different 
test<-boops %>% 
  filter(!Ecoregion %in% c("Klamath", 
                           "Sierra Nevada", 
                           "Cascades"))
testmat<-AllSpp %>% filter(!Ecoregion.1 %in% c("Klamath", 
                           "Sierra Nevada", 
                           "Cascades"))

smat<-testmat[,10:ncol(testmat)] 
smat[smat>0]<-1

## Add hulls to distinguish statistically significant groups 
# Hull data  
Mountains <- boops[boops$category == "mountain",][chull(boops[boops$category == "mountain", c("NMDS1", "NMDS2")]),]  
Coast <- boops[boops$category == "coast", ][chull(boops[boops$category == "coast", c("NMDS1", "NMDS2")]), ]  

# Combine all ecoregions
hull.data <- rbind(Mountains, Coast)  


NMDSplot2<-ggplot() +
  geom_polygon(data=hull.data,aes(x=NMDS1,y=NMDS2, fill=category, group=category),alpha=0.30)+
  geom_point(data=data.scores, aes(x=NMDS1, y=NMDS2, colour=Ecoregion), size=2)+
  geom_text_repel(data=species.scores, aes(x=NMDS1, y=NMDS2, label=species), size=2.5)+
  scale_colour_manual(values=cols)+
  scale_x_continuous(limits = c(-1.5, 1.5))+
  theme_bw()+scale_y_continuous(limits=c(-1.5,1.5)) 
NMDSplot2

# Combine NMDS plots and save 
nmds<-ggarrange(NMDSplot, NMDSplot2, 
            ncol=2, nrow=1, common.legend = TRUE, legend="right", labels=c("A", "B")) 
nmds

ggsave("./Figures/NMDSGraphs.png", width=9, height=5, dpi=600)
```


# Species Accumulation Curves in iNEXT for each Ecoregion 

```{r}
NextEco<-TotalEco %>% select(!EcoRich) %>% pivot_wider(names_from=Ecoregion.1, values_from=EcoAbund) %>% arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID")

str(NextEco)
#Species Richness, Hill Number 1
out<-iNEXT(NextEco, q=c(0), datatype="abundance", endpoint=1000)
ggiNEXT(out, type=1) + theme_bw(base_size=10) + scale_y_continuous( limits=c(0,12))
out
ggsave("./Figures/EcoregionRarefaction.png")
```

## Species Accumulation Curves in iNEXT for each site 
```{r}
#iNEXT package uses species by site dataframes
#Transform data (opposite of vegan package) and make species names as row names instead of column 
head(TotalBreakdown)
commatrix<-TotalBreakdown %>% select(!c(Date_comb, Ecoregion.1, TotalAbundance, SpeciesRichness,  Ecoregion)) %>% unique()

NEXTSppALL<- commatrix%>% pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID")
NEXTSppALL

#Rarefactions for all ecoregions in one graph 
str(NEXTSppALL)
#Species Richness, Hill Number 1
out<-iNEXT(NEXTSppALL, q=c(0), datatype="abundance", endpoint=150)

ggiNEXT(out, type=1) + theme_bw(base_size=10)

ggsave("./Figures/SiteRarefaction.png")
```

### Rarefactions for Sierra Nevada
```{r, include=FALSE}
library(scales)
#Make dataframes for each ecoregion (6 total)
#Make general dataframe that can then be filtered by ecoregion
head(TotalBreakdown)
dfeco<-TotalBreakdown %>% select(!c(Date_comb, TotalAbundance, SpeciesRichness,  Ecoregion)) %>% unique()

#SierraNevada
NEXTSppSN<-dfeco %>% filter(Ecoregion.1=="Sierra Nevada") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)

str(NEXTSppSN)
out<-iNEXT(NEXTSppSN, q=c(0), datatype="abundance", endpoint=150)

SN<-ggiNEXT(out, type=1)+
  theme_bw(base_size=10)+
  guides(linetype=FALSE)+ 
  theme(legend.position = "bottom",legend.title=element_blank(),text=element_text(size=8),
        plot.title=element_text(size=10), legend.key.size = unit(0.5, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Sierra Nevada")+geom_line(size = .3) + scale_y_continuous(breaks=pretty_breaks(), limits=c(0,9))
  
SN

```



### Coastal Sage
```{r,  include=FALSE}
TotalBreakdown
NEXTSppCS<-dfeco %>% filter(Ecoregion.1 =="Coastal Sage") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)

str(NEXTSppCS)
out<-iNEXT(NEXTSppCS, q=c(0), datatype="abundance", endpoint=150)
CS<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Coastal Sage") + scale_colour_manual(values="seagreen4") + scale_fill_manual(values="seagreen2")  +ylim(0,9)+geom_line(size = .3)
```


### Coast Range
```{r, include=FALSE}
NEXTSppCR<-dfeco %>% filter(Ecoregion.1=="Coast Range") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)

str(NEXTSppCR)
out<-iNEXT(NEXTSppCR, q=c(0), datatype="abundance", endpoint=150)
CR<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Coast Range") + scale_colour_manual(values=c("darkorchid4", "aquamarine4", "hotpink4", "steelblue4")) + scale_fill_manual(values=c("thistle1", "cadetblue1", "thistle3", "lightsteelblue1")) +ylim(0,9)+geom_line(size = .3)
```

### Klamath
```{r, include=FALSE}
TotalBreakdown %>% select(Ecoregion, Ecoregion.1) %>% unique()
NEXTSppK<-dfeco %>% filter(Ecoregion.1=="Klamath") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppK
str(NEXTSppK)
out<-iNEXT(NEXTSppK, q=c(0), datatype="abundance", endpoint=150)
K<-ggiNEXT(out, type=1) +theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Klamath Mountains")+ scale_colour_manual(values=c("deepskyblue4", "indianred4")) + scale_fill_manual(values=c("deepskyblue2", "indianred1")) +ylim(0,9)+geom_line(size = .3)
```

### Cascades
```{r, include=FALSE}
NEXTSppC<-dfeco %>% filter(Ecoregion.1=="Cascades") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppC
str(NEXTSppC)
out<-iNEXT(NEXTSppC, q=c(0), datatype="abundance", endpoint=150)
C<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Cascades")+scale_colour_manual(values="navyblue") + scale_fill_manual(values="lightsteelblue2") +ylim(0,9)+geom_line(size = .3)
```

### CentralBasin
```{r}
NEXTSppCB<-dfeco %>% filter(Ecoregion.1=="Central Basin") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppCB
str(NEXTSppCB)
out<-iNEXT(NEXTSppCB, q=c(0), datatype="abundance", endpoint=150)
CB<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Central Basin")+
  scale_colour_manual(values="orangered3") + scale_fill_manual(values="orange1") +ylim(0,9)+geom_line(size = .3)


rarefactions<-ggarrange(SN, CS, CR, K, C, CB, 
            ncol=3, nrow=2)
rarefactions
ggsave("./Figures/SiteRarefactionGraphs.png", width=7, height=5, dpi=600)
```

