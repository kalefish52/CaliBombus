---
title: "CaliBombus"
author: Kaleigh Fisher and Kristal Watrous
date: 14 July 2020
output: html_document
---
#Load Necessary Packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(vegan)
library(janitor)
library(gtsummary)
library(tibble)
library(iNEXT)
library(ggrepel)
library(ggpubr)

```

#Load all data 
##Filter out non-Bombus samples
##Select relevant data columns for downstream analyses 
```{r, include=FALSE}
data<-read.csv("../CaliBombus/CaliBombus_inventory_main.csv")
#data <- read.csv("/Volumes/GoogleDrive/My Drive/Kristal_WoodardLab/2020 Projects/2020.CalibombusCommunities/Analyses/CaliBombus_inventory_main.csv")
head(data)
dataALL <- data %>% filter(!Verified.Bee.species.ID %in% c("", "NA - Andrena?", "NA - Anthophorid", "NA - Anthophorid?", "NA - fly (bumble mimic)", "NA - nonBombus", "NA - Osmia?", "NA - robber fly", "NA - Xylocopa")) %>% select(Bee.Unique.ID, Date_comb, Date_reformat, Locality_reformat, Latitude, Longitude, Site_Grouping, Ecoregion, Elevation_ft, County, Collector, Verified.Bee.species.ID, sex.caste)
head(dataALL)


```

#Filter data by final sites (>10km apart)
```{r, include=FALSE}
#Group species by site_grouping and date of collection (pooled sites that are less than >20 km apart) and make species richness column for each site and species abundance column 
speciesCOUNT<-dataALL %>% group_by(Site_Grouping) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(SpeciesRichness=sum(count)) %>% rename("SpeciesAbundance"=n) 


#Add Total Abundance column(total number of bombus/site)
speciesCOUNT<-speciesCOUNT %>% mutate(TotalAbundance=sum(SpeciesAbundance))


#Merge richness/abundance info with site characteristics by Site_Grouping
#Use this data frame for sampling time specific questions
dataTOTAL<-left_join(dataALL, speciesCOUNT, by=c("Site_Grouping", 
                                               "Verified.Bee.species.ID"))


```

# Combine dates that are within 3 days of each other
```{r, include=FALSE}

#Combine sampling times for sites that were collected within 3 days of each other 

#Change date format so we can do math
head(dataALL)
dates<-str_remove(dataALL$Date_comb, "-")
dates<-str_remove(dates, "-")
dataALL$Date<-as.Date(dates, "%d%b%Y")
#Make column with number of days between sampling dates 
dateRANGE <-dataALL %>% group_by(Site_Grouping) %>% mutate(range=(max(Date)-min(Date)))

#Find all sites with less than three days to combine - do not rerun because changed manually in CaliBombus_inventor_main.csv file 
#dateRANGE %>% filter(range != 0 & range <= 3) %>% unique() %>% select(Site_Grouping, Date, range) %>% unique()

dataALL %>% select(Locality_reformat, Ecoregion) %>% unique()

## Changed dates for SC, MK, WM to earliest collection date to combine manually in excel as Date_comb
## also edited verified species ID in Excel to change "tent. vosi" to "vosnesenskii"
```


#Filter data by final sites (>10 km apart) and sampling time
```{r, echo=FALSE}
#Group species by site_grouping and date of collection (pooled sites that are less than >20 km apart) and make species richness column for each site and species abundance column 

speciesCOUNT<-dataALL %>% filter(Site_Grouping != "misc") %>% group_by(Site_Grouping, Date_comb) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(SpeciesRichness=sum(count)) %>% rename("SpeciesAbundance"=n) 

#Add Total Abundance column(total number of bombus/site)
speciesCOUNT<-speciesCOUNT %>% mutate(TotalAbundance=sum(SpeciesAbundance))

#Merge richness/abundance info with site characteristics by Site_Grouping
#Use this data frame for sampling time specific questions
dataTIME<-left_join(dataALL, speciesCOUNT, by=c("Site_Grouping", 
                                               "Date_comb", "Verified.Bee.species.ID"))
head(dataTIME)

#How many sites have more than one sampling time and how many bees were collected? 
plot<-dataTIME %>% filter(Site_Grouping != "misc") %>% select(Date_comb, Site_Grouping, TotalAbundance) %>% unique()


ggplot(plot, aes(x=Site_Grouping, y=TotalAbundance, fill=Date_comb))+
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))


```


#Filter data by number collected / sampling time 
```{r, echo=FALSE}
#Filter based on having at least 110 individuals / site total 
dataFILT110<-dataTOTAL %>% filter(TotalAbundance>=110)
dataFILT110 %>% group_by(Site_Grouping)  %>% tally()
print("There are 6 sites with at least 110 bees collected / site")
dataFILT100<-dataTOTAL %>% filter(TotalAbundance>=100)
dataFILT100 %>% group_by(Site_Grouping)%>% tally()
print("There are 16 sites with at least 100 bees collected / site")
head(dataTOTAL)
#Filter based on each site having at least 105 individuals / sampling time 
dataTIME105<-dataTIME %>% filter(TotalAbundance>=105)
dataTIME105 %>% group_by(Site_Grouping) %>% tally()
print("There are 8 sites with at least 105 bees collected / site / sampling time")
dataTIME100<-dataTIME %>% filter(TotalAbundance>=100)
dataTIME100 %>% group_by(Site_Grouping) %>% tally()
print("There are 14 sites with at least 100 bees collected / site / sampling time")
dataTIME80<-dataTIME %>% filter(TotalAbundance>=80)
dataTIME80 %>% group_by(Site_Grouping) %>% tally()
print("There are 17 sites with at least 80 bees collected / site / sampling time")


```

## Now that we have counts per site, filter out any extras based on site/time
```{r, echo=FALSE}
## First things first, filter any data we'll want to exclude based on site/time - 
# Chose one time per site based on which timepoint had greatest abundance
## We are currently considering:
  ## Oakhurst (OA: 104 in May, exclude June)
  ## North Fork (NF: 98 in June, exclude may)
  ## Wawona (WA: 84 in June, exclude July)

dataFinal<-dataTIME %>% filter(Site_Grouping != "misc") %>% filter(!Date_comb %in% c("3-Jun-19","7-May-19","6-Jul-19")) %>% select(Date_comb, Site_Grouping, Ecoregion, Verified.Bee.species.ID, sex.caste, SpeciesAbundance, SpeciesRichness, TotalAbundance, Latitude, Longitude, Elevation_ft) 

#Combine californicus and fervidus as one species, according to Leif's characterization
dataFinal<-dataFinal %>% 
  mutate(Verified.Bee.species.ID=recode(Verified.Bee.species.ID, californicus="fervidus")) %>% mutate(sex.caste=recode(sex.caste, female="worker")) 

##FINAL SITES - Grouped with 10km of each other and one sampling time per site 
FinalSites<-dataFinal %>% select(Date_comb, Site_Grouping, TotalAbundance) %>% unique()
FinalSites
ggplot(FinalSites, aes(x=Site_Grouping, y=TotalAbundance, fill=Date_comb))+
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

dataFinal

```
## Add USGS Ecoregion Info
```{r}
head(dataALL)
Ecoregions<-read.csv("./spatialinfofinal.csv") %>% select(Site_Grouping, Ecoregion.1, EcoregionNum)
head(Ecoregions)
#Join USGS ecoregion info with existing dataframe
dataUSE<-left_join(dataFinal, Ecoregions, by="Site_Grouping")
head(dataUSE)
dataFINAL<-dataUSE %>% select(!Ecoregion)
dataFINAL
```

## How many specific individuals (species) do we have? 
```{r}
head(dataFINAL)
caliginosus<-dataFINAL %>% select(Site_Grouping, Ecoregion.1, SpeciesAbundance, Verified.Bee.species.ID, TotalAbundance) %>% unique() %>% filter(Verified.Bee.species.ID=="caliginosus") %>% mutate(PCal=((SpeciesAbundance/TotalAbundance)*100))
totalcollected<-caliginosus %>% mutate(totalcal=sum(SpeciesAbundance))
print(paste("We collected 36 caliginosus across all sites" ))
caliginosus
ggplot(caliginosus, aes(x=Site_Grouping, y=PCal)) + geom_bar(stat="identity") + ggtitle("Percentage caliginosus at each site")

insularis<-dataFINAL%>% select(Site_Grouping, Ecoregion.1, SpeciesAbundance, Verified.Bee.species.ID, TotalAbundance) %>% unique() %>% filter(Verified.Bee.species.ID=="insularis")
insularis

```

## Site and Ecoregion Characteristics and Informations - Descriptive Information for Mansucript
```{r, echo=FALSE}
#What is the average number of bees per site? 
AvgMeanSite<-dataFINAL %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(mean=mean(TotalAbundance))
sdMeanSite<-dataFINAL %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% 
  summarize(SD=sd(TotalAbundance))
print(paste("We sampled a mean of", AvgMeanSite, "bees per site with a standard deviation of", sdMeanSite))
#What is the min/max number of bees per site? 
MinSite<-dataFINAL %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(Min=min(TotalAbundance))
MinSite
MaxSite<-dataFINAL %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(Min=max(TotalAbundance))
MaxSite

#What is the average richness per site?
AvgRichSite<-dataFINAL %>% select(Site_Grouping, SpeciesRichness) %>% unique() %>% summarize(mean=mean(SpeciesRichness))
sdRichSite<-dataFINAL %>% select(Site_Grouping, SpeciesRichness) %>% unique() %>% 
  summarize(SD=sd(SpeciesRichness))
print(paste("We sampled a mean of", AvgRichSite, "bee richness per site with a standard deviation of", sdRichSite))

#How many males did we collect total relative to females across all sites? 
TotalSexCollected<-dataFINAL %>% select(sex.caste) %>% mutate(count=1) %>% group_by(sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, total)
TotalSexCollected %>% mutate(RelativeAbundance=(total/sum(TotalSexCollected$total))*100)
TotalSexCollected
ggplot(TotalSexCollected, aes(x=sex.caste, y=total)) +geom_bar(stat="identity")

#How many males did we collect per site? 
SiteSex<-dataFINAL %>% select(sex.caste, Site_Grouping) %>% mutate(count=1) %>%  group_by(Site_Grouping, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Site_Grouping, total) 
ggplot(SiteSex, aes(x=Site_Grouping, y=total, fill=sex.caste)) +geom_bar(stat="identity")

#How many males did we collect per ecoregion? 
SiteEcoregion<-dataFINAL %>% select(sex.caste, Ecoregion.1) %>% mutate(count=1) %>%  group_by(Ecoregion.1, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Ecoregion.1, total) 
SiteEcoregion  %>% group_by(Ecoregion.1) %>% mutate(totinds=sum(total)) %>% ungroup() %>%  
  mutate(propcaste=total/totinds)


ggplot(SiteEcoregion, aes(x=Ecoregion.1, y=total, fill=sex.caste)) +geom_bar(stat="identity")+xlab("Ecoregion")+ylab("Number Bees Collected")
ggsave("CasteRatios.png", dpi=600)

```

## Table 1 Information
How many sites and regions had which species?? 
Includes the number of sites and ecoregions with which species 
Treating all individuals collected equally (ie. males=females=queens)
```{r, echo=FALSE}
dataFINAL 
#Remove sex.caste information 
TotalBreakdown <- dataFINAL %>% select(!c(sex.caste, Latitude, Longitude, Elevation_ft))

#Number of ecoregions for each species
EcoregionNum<-TotalBreakdown %>% select(Ecoregion.1, Verified.Bee.species.ID) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(count=1) %>% 
  mutate(ecoregionnum=sum(count)) %>% select(Verified.Bee.species.ID, ecoregionnum) %>% unique()

#Number of sites for each species
SiteNum<-TotalBreakdown %>% select(Verified.Bee.species.ID, Site_Grouping) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(count=1) %>% 
  mutate(Sitenum=sum(count)) %>% select(Verified.Bee.species.ID, Sitenum) %>% unique()

#Total number of individuals for each species 
Totalspecies<-TotalBreakdown %>% select(Verified.Bee.species.ID, SpeciesAbundance, Site_Grouping) %>% unique() %>% group_by(Verified.Bee.species.ID) %>% mutate(totalspeciesabundance=sum(SpeciesAbundance)) %>% select(Verified.Bee.species.ID, totalspeciesabundance) %>% unique()
Totalspecies

SummComm<-left_join(SiteNum, EcoregionNum, by="Verified.Bee.species.ID")
SummComm<-SummComm %>% rename(Number_of_Sites=Sitenum) %>% rename(Number_of_Ecoregions=ecoregionnum) 
CommunityInfo<-left_join(SummComm, Totalspecies, by="Verified.Bee.species.ID")
Finaldescript<-CommunityInfo %>% 
  mutate(Percentage=(totalspeciesabundance/(sum(CommunityInfo$totalspeciesabundance))*100))
Finaldescript
write.csv(Finaldescript, file="Table1.csv")


```

#Transform data with species abundance for each site/ecoregion in order to do diversity statistics
Use AllSpp for all diversity analyses 
```{r, echo=FALSE}
head(TotalBreakdown)
##Site Level Numbers 
AllSpp<-TotalBreakdown %>% unique() %>% pivot_wider(names_from = Verified.Bee.species.ID, values_from = SpeciesAbundance) %>% arrange(Site_Grouping)
#Replace NAs with 0 
AllSpp <- AllSpp %>% replace(is.na(.), 0)
AllSpp

##Ecoregion level numbers
EcoregionData<-
  TotalBreakdown %>% unique() %>%select(Ecoregion.1, Verified.Bee.species.ID, SpeciesAbundance) %>% group_by(Ecoregion.1) %>% mutate(EcoAbund=sum(SpeciesAbundance)) %>% select(!SpeciesAbundance) %>% unique()

EcoRich<-EcoregionData %>% select(!EcoAbund) %>% group_by(Ecoregion.1) %>% mutate(count=1) %>% mutate(EcoRich=sum(count)) %>% select(!c(count, Verified.Bee.species.ID)) %>% unique()

EcoSpp<-EcoregionData %>% pivot_wider(names_from=Verified.Bee.species.ID, values_from=EcoAbund)
EcoSpp <- EcoSpp %>% replace(is.na(.), 0)

TotalEco<-left_join(EcoregionData, EcoRich, by="Ecoregion.1")
TotalEco
```

## Table 2:  Diversity, Richness Metrics by Ecoregion and by Site
```{r, echo=FALSE}
# Shannon's Diversity for Ecoregion level and Site Level 
##Site Level 
Shannonmatrix<-AllSpp %>% select(!c(Date_comb, SpeciesRichness, TotalAbundance, Ecoregion.1, Site_Grouping))
Shannonmatrix
Matrix<-as.matrix(Shannonmatrix)
SiteShannon<-diversity(Matrix, index="shannon") %>% as.vector()
#Combine ShannonDiversity Values with Site Names 
Site_Grouping<-AllSpp$Site_Grouping
Site_Shannon<-cbind(Site_Grouping, SiteShannon)
Site_Shannon<-as.data.frame(Site_Shannon)

##Ecoregion Level 
Ecomatrix<-EcoSpp %>% ungroup() %>% select(!Ecoregion.1) %>% as.matrix()

EcoShannon<-diversity(Ecomatrix, index="shannon") %>% as.vector()
Ecoregion.1<-EcoSpp$Ecoregion.1
Eco_Shannon<-cbind(Ecoregion.1, EcoShannon)
Eco_Shannon<-as.data.frame(Eco_Shannon)
Eco_Shannon
All_Eco<-left_join(TotalEco, Eco_Shannon, by="Ecoregion.1") %>% ungroup() %>% select(Ecoregion.1, EcoAbund, EcoRich, EcoShannon) %>% unique()
FinalEco<-All_Eco %>% group_by(Ecoregion.1) %>% mutate(EcoAbundTot=sum(EcoAbund)) %>% select(!EcoAbund) %>% unique()
FinalEco
write.csv(FinalEco, "EcoregionMetrics.csv")



#Combine Diversity Metrics with Total Breakdown data for site level info
head(TotalBreakdown)
#SpeciesAbundance and Species Richness are both Site Level Values 
All_Site<-left_join(TotalBreakdown, Site_Shannon, by="Site_Grouping")
head(All_Site)

AllSiteRich<-All_Site %>% select(Site_Grouping, Ecoregion.1, SpeciesRichness, TotalAbundance, SiteShannon) %>% unique()
AllSiteRich

```
## Supplementary Table 1 
```{r}
SuppTable<-AllSpp %>% select(!c(SpeciesRichness, EcoregionNum)) %>%
  rename("Date Collected"=Date_comb) %>% 
  rename("Site"=Site_Grouping) %>% 
  rename("Ecoregion"=Ecoregion.1) %>% 
  group_by(Ecoregion)
SuppTable

 
```



# NMDS - see if species change based on Ecoregion
We did not find any significant differences in community composition between ecoregions
```{r, width = 5, height = 5, dpi=600}
# Convert data into community matrix sith species as columns and communities (sites) as rows - remove all columns except for species columns 
comm_matrix<-AllSpp[,7:ncol(AllSpp)] %>% as.matrix()
set.seed(123456)
NMDS=metaMDS(comm_matrix, k=2, distance="bray") 
stressplot(NMDS)
NMDS #Stress ok 

#Get data scores and make new dataframe with site, ecoregion and collection date information
data.scores<-as.data.frame(scores(NMDS))
data.scores$date <- AllSpp$Date_comb
data.scores$Site <-AllSpp$Site_Grouping
data.scores$Ecoregion <-AllSpp$Ecoregion.1
data.scores

#Gets NMDS info for each behavior
species.scores<-as.data.frame(scores(NMDS, "species"))
species.scores$species<-rownames(species.scores)
species.scores

                                                                                      
## Anosim - are communities different by ecoregion
ano = anosim(comm_matrix, data.scores$Ecoregion, distance = "bray", permutations = 9999)
ano

#No significant differences between ecoregions in community composition

# NMDS  with Vos Removed 
vosmatrix<-AllSpp[,8:ncol(AllSpp)] %>% as.matrix()
set.seed(123456)
NMDSvos=metaMDS(vosmatrix, k=2, distance="bray") 
stressplot(NMDSvos)
NMDSvos #Stress ok 

#Get data scores and make new dataframe with site, ecoregion and collection date information
data.scoresvos<-as.data.frame(scores(NMDSvos))
data.scoresvos$date <- AllSpp$Date_comb
data.scoresvos$Site <-AllSpp$Site_Grouping
data.scoresvos$Ecoregion <-AllSpp$Ecoregion.1
head(data.scoresvos)

#Gets NMDS info for each behavior
species.scoresvos<-as.data.frame(scores(NMDSvos, "species"))
species.scoresvos$species<-rownames(species.scoresvos)

## Anosim - are communities different by ecoregion
ano = anosim(vosmatrix, data.scores$Ecoregion, distance = "bray", permutations = 9999)
ano

## Plot both plots 
## Plot it using ggplot
NMDSvosplot<-ggplot() + geom_point(data=data.scores, aes(x=NMDS1, y=NMDS2, colour=Ecoregion), size=2)+ geom_text_repel(data=species.scores, aes(x=NMDS1, y=NMDS2, label=species), position=position_jitter(width=1,height=1)) +scale_x_continuous(limits = c(-3.5, 3.5))
NMDSvosplot


NMDSvosno<-ggplot() + geom_point(data=data.scoresvos, aes(x=NMDS1, y=NMDS2, colour=Ecoregion), size=2)+ geom_text_repel(data=species.scoresvos, aes(x=NMDS1, y=NMDS2, label=species))+scale_x_continuous(limits = c(-3, 3))
NMDSvosno

ggarrange(NMDSvosplot, NMDSvosno, 
            ncol=1, widths=c(1,1), common.legend=TRUE, 
          legend="right", labels=c("A", "B"))

ggsave("NMDS.png", width=7, height=6, dpi=600)

```


## Run Anosims for each ecoregion
```{r}
## Subset ecoregions and then run anosim between subsets 
Klamath<-AllSpp %>% filter(Ecoregion.1 == "Klamath") %>% mutate(system=
                                                                  "mountains")
Cascades<-AllSpp %>% filter(Ecoregion.1 == "Cascades") %>% mutate(system=
                                                                    "mountains")
SierraNevada<-AllSpp %>% filter(Ecoregion.1 == "SierraNevada")%>% mutate(system=
                                                                    "mountains")

CoastRange<-AllSpp %>% filter(Ecoregion.1 == "CoastRange") %>% mutate(system=
                                                                    "coast")
CoastalSage<-AllSpp %>% filter(Ecoregion.1 == "CoastalSage")%>% mutate(system=
                                                                    "coast")

CentralBasin<-AllSpp %>% filter(Ecoregion.1 == "CentralBasin")%>% mutate(system=
                                                                    "whitemountains")

#Are the white mountains different from the coast? 
mc1<-rbind(CentralBasin, CoastalSage, CoastRange) 
mc<-mc1 %>% select(!system)
mcmatrix<-mc[,8:ncol(mc)] %>% as.matrix()
set.seed(123456)
mcNMDS=metaMDS(mcmatrix, k=2, distance="bray") 
stressplot(mcNMDS)
data.scoresmc<-as.data.frame(scores(mcNMDS))
data.scoresmc$system<-mc1$system
anomc = anosim(mcmatrix, data.scoresmc$system, distance = "bray", permutations = 9999)
anomc

#Change Central Basin to coast because they are similar 
#Are the mountains vs. the coast (+ white mountains) distinct 
CentralBasin<-AllSpp %>% filter(Ecoregion.1 == "CentralBasin")%>% mutate(system="coast")
systemall<-rbind(Klamath, Cascades, SierraNevada, CoastRange, CoastalSage, CentralBasin)
syst<-systemall %>% select(!system)
systm<-syst[,8:ncol(syst)] %>% as.matrix()
set.seed(123456)
systNMDS=metaMDS(systm, k=2, distance="bray") 
stressplot(systNMDS)
data.scoressyst<-as.data.frame(scores(systNMDS))
data.scoressyst$system<-systemall$system
anomsy = anosim(systm, data.scoressyst$system, distance = "bray", permutations = 9999)
anomsy    


## Is the central basin different from the others when vos is included? 
vosmc<-syst[,7:ncol(syst)] %>% as.matrix()
vosmc
vosmcNMDS=metaMDS(vosmc, k=2, distance="bray") 

data.scoresvm<-as.data.frame(scores(vosmcNMDS))
data.scoresvm$system<-systemall$system
anomsvm = anosim(vosmc, data.scoresvm$system, distance = "bray", permutations = 9999)
anomsvm 

```



## Species Accumulation Curves and Chao1 in Vegan 
```{r}
# Need to convert dataframe to a matrix and remove columns and make site names row names

SpeciesAcc<-AllSpp %>% select(!c(Date_comb, Ecoregion.1, SpeciesRichness, TotalAbundance)) %>% column_to_rownames(var="Site_Grouping")
SpeciesAcc %>% as.matrix()
SpeciesAcc
rarecurve(SpeciesAcc, label=TRUE, cex=0.4, col="blue")
estimateR(SpeciesAcc)
#S.Chao1 is estimated species pool 
```

## Species Accumulation Curves in iNEXT
```{r}
library(iNEXT)
#q=0 (richness)
#q=1 (shannon)
#q=2 (simpson)

#iNEXT package uses species by site dataframes
#Transform data (opposite of vegan package) and make species names as row names instead of column 
commatrix<-TotalBreakdown %>% select(!c(TotalAbundance, SpeciesRichness, Date_comb, Ecoregion.1, EcoregionNum)) %>% unique()


NEXTSppALL<- commatrix%>% pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID")
NEXTSppALL

#Rarefactions for all ecoregions in one graph 
str(NEXTSppALL)
#Species Richness, Hill Number 1
out<-iNEXT(NEXTSppALL, q=c(1), datatype="abundance", endpoint=150)
ggiNEXT(out, type=1) + theme_bw(base_size=10)

```
## Rarefactions for Sierra Nevada
```{r}
#Make dataframes for each ecoregion (6 total)
#Make general dataframe that can then be filtered by ecoregion
dfeco<-TotalBreakdown %>% select(!c(TotalAbundance, SpeciesRichness, Date_comb, EcoregionNum)) %>% unique()
dfeco

#SierraNevada
NEXTSppSN<-dfeco %>% filter(Ecoregion.1=="SierraNevada") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppSN
str(NEXTSppSN)
out<-iNEXT(NEXTSppSN, q=c(1), datatype="abundance", endpoint=150)
SN<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.5, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Sierra Nevada")
```



#CoastalSage
```{r}
NEXTSppCS<-dfeco %>% filter(Ecoregion.1=="CoastalSage") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppCS
str(NEXTSppCS)
out<-iNEXT(NEXTSppCS, q=c(1), datatype="abundance", endpoint=150)
CS<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Coastal Sage")

```


#CoastRange
```{r}
NEXTSppCR<-dfeco %>% filter(Ecoregion.1=="CoastRange") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppCR
str(NEXTSppCR)
out<-iNEXT(NEXTSppCR, q=c(1), datatype="abundance", endpoint=150)
CR<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Coast Range")
```

#Klamath
```{r}
NEXTSppK<-dfeco %>% filter(Ecoregion.1=="Klamath") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppK
str(NEXTSppK)
out<-iNEXT(NEXTSppK, q=c(1), datatype="abundance", endpoint=150)
K<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Klamath Mountains")

```

#Cascades
```{r}
NEXTSppC<-dfeco %>% filter(Ecoregion.1=="Cascades") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppC
str(NEXTSppC)
out<-iNEXT(NEXTSppC, q=c(1), datatype="abundance", endpoint=150)
C<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Cascades")


```

#CentralBasin
```{r}
NEXTSppCB<-dfeco %>% filter(Ecoregion.1=="CentralBasin") %>%  pivot_wider(names_from = Site_Grouping, values_from =SpeciesAbundance) %>% 
  arrange(Verified.Bee.species.ID) %>% replace(is.na(.), 0) %>% column_to_rownames(var="Verified.Bee.species.ID") %>% select(!Ecoregion.1)
NEXTSppCB
str(NEXTSppCB)
out<-iNEXT(NEXTSppCB, q=c(1), datatype="abundance", endpoint=150)
CB<-ggiNEXT(out, type=1) + theme_bw(base_size=10)+guides(linetype=FALSE)+ theme(legend.position = "bottom",
 legend.title=element_blank(),text=element_text(size=8), plot.title=element_text(size=10), legend.key.size = unit(0.2, "cm"), legend.key.width = unit(0.05,"cm")) + ggtitle("Central Basin")




rarefactions<-ggarrange(SN, CS, CR, K, C, CB, 
            ncol=3, nrow=2) 
ggsave("rarefaction.png", width=7, height=5, dpi=600)


```

