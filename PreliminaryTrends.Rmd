---
title: "CaliBombus"
author: Kaleigh Fisher and Kristal Watrous
date: 14 July 2020
output: html_document
---
#Load Necessary Packages
```{r, echo=FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(tidyr)
library(vegan)
library(janitor)
library(gtsummary)
```

#Load all data 
##Filter out non-Bombus samples
##Select relevant data columns for downstream analyses 
```{r}
data<-read.csv("../CaliBombus/CaliBombus_inventory_main.csv")
#data <- read.csv("/Volumes/GoogleDrive/My Drive/Kristal_WoodardLab/2020 Projects/2020.CalibombusCommunities/Analyses/CaliBombus_inventory_main.csv")
head(data)
dataALL <- data %>% filter(!Verified.Bee.species.ID %in% c("", "NA - Andrena?", "NA - Anthophorid", "NA - Anthophorid?", "NA - fly (bumble mimic)", "NA - nonBombus", "NA - Osmia?", "NA - robber fly", "NA - Xylocopa")) %>% select(Bee.Unique.ID, Date_comb, Date_reformat, Locality_reformat, Latitude, Longitude, Site_Grouping, Ecoregion, Elevation_ft, County, Collector, Verified.Bee.species.ID, sex.caste)
head(dataALL)


```
#Filter data by final sites (>10km apart)
```{r}
#Group species by site_grouping and date of collection (pooled sites that are less than >20 km apart) and make species richness column for each site and species abundance column 
speciesCOUNT<-dataALL %>% group_by(Site_Grouping) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(SpeciesRichness=sum(count)) %>% rename("SpeciesAbundance"=n) 


#Add Total Abundance column(total number of bombus/site)
speciesCOUNT<-speciesCOUNT %>% mutate(TotalAbundance=sum(SpeciesAbundance))


#Merge richness/abundance info with site characteristics by Site_Grouping
#Use this data frame for sampling time specific questions
dataTOTAL<-left_join(dataALL, speciesCOUNT, by=c("Site_Grouping", 
                                               "Verified.Bee.species.ID"))


```

# Combine dates that are within 3 days of each other
```{r}

#Combine sampling times for sites that were collected within 3 days of each other 

#Change date format so we can do math
head(dataALL)
dates<-str_remove(dataALL$Date_comb, "-")
dates<-str_remove(dates, "-")
dataALL$Date<-as.Date(dates, "%d%b%Y")
#Make column with number of days between sampling dates 
dateRANGE <-dataALL %>% group_by(Site_Grouping) %>% mutate(range=(max(Date)-min(Date)))

#Find all sites with less than three days to combine - do not rerun because changed manually in CaliBombus_inventor_main.csv file 
#dateRANGE %>% filter(range != 0 & range <= 3) %>% unique() %>% select(Site_Grouping, Date, range) %>% unique()



## Changed dates for SC, MK, WM to earliest collection date to combine manually in excel as Date_comb
## also edited verified species ID in Excel to change "tent. vosi" to "vosnesenskii"
```

#Filter data by final sites (>10 km apart) and sampling time
```{r}
#Group species by site_grouping and date of collection (pooled sites that are less than >20 km apart) and make species richness column for each site and species abundance column 

speciesCOUNT<-dataALL %>% filter(Site_Grouping != "misc") %>% group_by(Site_Grouping, Date_comb) %>% count(Verified.Bee.species.ID) %>% mutate(count=1) %>% mutate(SpeciesRichness=sum(count)) %>% rename("SpeciesAbundance"=n) 
speciesCOUNT

#Add Total Abundance column(total number of bombus/site)
speciesCOUNT<-speciesCOUNT %>% mutate(TotalAbundance=sum(SpeciesAbundance))

#Merge richness/abundance info with site characteristics by Site_Grouping
#Use this data frame for sampling time specific questions
dataTIME<-left_join(dataALL, speciesCOUNT, by=c("Site_Grouping", 
                                               "Date_comb", "Verified.Bee.species.ID"))
head(dataTIME)

#How many sites have more than one sampling time and how many bees were collected? 
plot<-dataTIME %>% filter(Site_Grouping != "misc") %>% select(Date_comb, Site_Grouping, TotalAbundance) %>% unique()

ggplot(plot, aes(x=Site_Grouping, y=TotalAbundance, fill=Date_comb))+
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))


```


#Filter data by number collected / sampling time 
```{r}
#Filter based on having at least 110 individuals / site total 
dataFILT110<-dataTOTAL %>% filter(TotalAbundance>=110)
dataFILT110 %>% group_by(Site_Grouping)  %>% tally()
print("There are 6 sites with at least 110 bees collected / site")
dataFILT100<-dataTOTAL %>% filter(TotalAbundance>=100)
dataFILT100 %>% group_by(Site_Grouping)%>% tally()
print("There are 16 sites with at least 100 bees collected / site")
head(dataTOTAL)
#Filter based on each site having at least 105 individuals / sampling time 
dataTIME105<-dataTIME %>% filter(TotalAbundance>=105)
dataTIME105 %>% group_by(Site_Grouping) %>% tally()
print("There are 8 sites with at least 105 bees collected / site / sampling time")
dataTIME100<-dataTIME %>% filter(TotalAbundance>=100)
dataTIME100 %>% group_by(Site_Grouping) %>% tally()
print("There are 14 sites with at least 100 bees collected / site / sampling time")
dataTIME80<-dataTIME %>% filter(TotalAbundance>=80)
dataTIME80 %>% group_by(Site_Grouping) %>% tally()
print("There are 17 sites with at least 80 bees collected / site / sampling time")


```

## Now that we have counts per site, filter out any extras based on site/time
```{r}
## First things first, filter any data we'll want to exclude based on site/time - 
# Chose one time per site based on which timepoint had greatest abundance
## We are currently considering:
  ## Oakhurst (OA: 104 in May, exclude June)
  ## North Fork (NF: 98 in June, exclude may)
  ## Wawona (WA: 84 in June, exclude July)

dataFinal<-dataTIME %>% filter(Site_Grouping != "misc") %>% filter(!Date_comb %in% c("7-May-19","3-Jun-19","6-Jul-19")) %>% select(Date_comb, Site_Grouping, Ecoregion, Verified.Bee.species.ID, sex.caste, SpeciesAbundance, SpeciesRichness, TotalAbundance) 


#Combine californicus and fervidus as one species, according to Leif's characterization
dataFinal
dataFinal<-dataFinal %>% 
  mutate(Verified.Bee.species.ID=recode(Verified.Bee.species.ID, californicus="fervidus")) %>% mutate(sex.caste=recode(sex.caste, female="worker")) 

##FINAL SITES - Grouped with 10km of each other and one sampling time per site 
FinalSites<-dataFinal %>% select(Date_comb, Site_Grouping, TotalAbundance) %>% unique()

ggplot(FinalSites, aes(x=Site_Grouping, y=TotalAbundance, fill=Date_comb))+
  geom_bar(stat="identity")+theme(axis.text.x=element_text(angle=90))

```

# Site and Ecoregion Characteristics and Informations - Descriptive Information for Mansucript
```{r}
#What is the average number of bees per site? 
AvgMeanSite<-dataFinal %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% summarize(mean=mean(TotalAbundance))
sdMeanSite<-dataFinal %>% select(Site_Grouping, TotalAbundance) %>% unique() %>% 
  summarize(SD=sd(TotalAbundance))
print(paste("We sampled a mean of", AvgMeanSite, "bees per site with a standard deviation of", sdMeanSite))
dataFinal
#How many males did we collect total relative to females across all sites? 
TotalSexCollected<-dataFinal %>% select(sex.caste) %>% mutate(count=1) %>% group_by(sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, total)
TotalSexCollected %>% mutate(RelativeAbundance=(total/sum(TotalSexCollected$total))*100)
TotalSexCollected
ggplot(TotalSexCollected, aes(x=sex.caste, y=total)) +geom_bar(stat="identity")
#How many males did we collect per site? 
SiteSex<-dataFinal %>% select(sex.caste, Site_Grouping) %>% mutate(count=1) %>%  group_by(Site_Grouping, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Site_Grouping, total) 
ggplot(SiteSex, aes(x=Site_Grouping, y=total, fill=sex.caste)) +geom_bar(stat="identity")

#How many males did we collect per ecoregion? 
SiteEcoregion<-dataFinal %>% select(sex.caste, Ecoregion) %>% mutate(count=1) %>%  group_by(Ecoregion, sex.caste) %>% mutate(total=sum(count)) %>% unique() %>% select(sex.caste, Ecoregion, total) 
ggplot(SiteEcoregion, aes(x=Ecoregion, y=total, fill=sex.caste)) +geom_bar(stat="identity")

```


#Table 1 Information
How many sites and regions had which species?? 
Includes the number of sites and ecoregions with which species 
Treating all inviduals collected equally 
```{r}
#Remove sex.caste information 
TotalBreakdown <- dataFinal %>% select(!sex.caste) %>% unique()
#Number of ecoregions for each species
EcoregionNum<-TotalBreakdown %>% select(Ecoregion, Verified.Bee.species.ID) %>% group_by(Verified.Bee.species.ID) %>% unique() %>% mutate(count=1) %>% 
  mutate(ecoregionnum=sum(count)) %>% select(Verified.Bee.species.ID, ecoregionnum) %>% unique()
#Number of sites for each species
SiteNum<-TotalBreakdown %>% select(Ecoregion, Verified.Bee.species.ID, Site_Grouping) %>% group_by(Verified.Bee.species.ID) %>% unique() %>% mutate(count=1) %>% 
  mutate(Sitenum=sum(count)) %>% select(Verified.Bee.species.ID, Sitenum) %>% unique()
SiteNum
  
#Total number of individuals for each species 
Totalspecies<-TotalBreakdown %>% select(Verified.Bee.species.ID, SpeciesAbundance) %>% group_by(Verified.Bee.species.ID) %>%  mutate(totalspeciesabundance=sum(SpeciesAbundance)) %>% select(Verified.Bee.species.ID, totalspeciesabundance) %>% unique()



SummComm<-left_join(SiteNum, EcoregionNum, by="Verified.Bee.species.ID")
SummComm<-SummComm %>% rename(Number_of_Sites=Sitenum) %>% rename(Number_of_Ecoregions=ecoregionnum) 
CommunityInfo<-left_join(SummComm, Totalspecies, by="Verified.Bee.species.ID")
Finaldescript<-CommunityInfo %>% 
  mutate(Percentage=(totalspeciesabundance/(sum(CommunityInfo$totalspeciesabundance))*100))
           
write.csv(Finaldescript, file="StrangeTable1.csv")

```

#Transform data with species abundance for each site/ecoregion in order to do diversity statistics
Use AllSpp for all diversity analyses 
```{r}
head(TotalBreakdown)
##Site Level Numbers 
AllSpp<-TotalBreakdown %>% pivot_wider(names_from = Verified.Bee.species.ID, values_from = SpeciesAbundance) %>% 
  arrange(Site_Grouping)
head(AllSpp)
#Replace NAs with 0 
AllSpp <- AllSpp %>% replace(is.na(.), 0)
AllSpp

##Ecoregion level numbers
EcoregionData<-TotalBreakdown %>% select(Ecoregion, Verified.Bee.species.ID, SpeciesAbundance) %>% group_by(Ecoregion, Verified.Bee.species.ID) %>% mutate(EcoAbund=sum(SpeciesAbundance)) %>% select(!SpeciesAbundance) %>% unique()

EcoRich<-EcoregionData %>% select(!EcoAbund) %>% group_by(Ecoregion) %>% mutate(count=1) %>% mutate(EcoRich=sum(count)) %>% select(!c(count, Verified.Bee.species.ID)) %>% unique()
EcoRich

EcoSpp<-EcoregionData %>% pivot_wider(names_from=Verified.Bee.species.ID, values_from=EcoAbund)
EcoSpp <- EcoSpp %>% replace(is.na(.), 0)

TotalEco<-left_join(EcoregionData, EcoRich, by="Ecoregion")
TotalEco

```

#Table 2:  Diversity, Richness Metrics by Ecoregion and by Site
```{r}
# Shannon's Diversity for Ecoregion level and Site Level 
##Site Level 
Shannonmatrix<-AllSpp %>% select(!c(Date_comb, SpeciesRichness, TotalAbundance, Ecoregion, Site_Grouping))

Matrix<-as.matrix(Shannonmatrix)
SiteShannon<-diversity(Matrix, index="shannon") %>% as.vector()
#Combine ShannonDiversity Values with Site Names 
Site_Grouping<-AllSpp$Site_Grouping
Site_Shannon<-cbind(Site_Grouping, SiteShannon)
Site_Shannon<-as.data.frame(Site_Shannon)

##Ecoregion Level 
Ecomatrix<-EcoSpp %>% ungroup() %>% select(!Ecoregion) %>% as.matrix()

EcoShannon<-diversity(Ecomatrix, index="shannon") %>% as.vector()
Ecoregion<-EcoSpp$Ecoregion
Eco_Shannon<-cbind(Ecoregion, EcoShannon)
Eco_Shannon<-as.data.frame(Eco_Shannon)
Eco_Shannon
All_Eco<-left_join(TotalEco, Eco_Shannon, by="Ecoregion")
head(All_Eco)



#Combine Diversity Metrics with TotalBreakdown data for site level info
head(TotalBreakdown)
#SpeciesAbundance and Species Richness are both Site Level Values 
All_Site<-left_join(TotalBreakdown, Site_Shannon, by="Site_Grouping")
head(All_Site)

```


# NMDS - see if species change based on Ecoregion
We did not find any significant differences in community composition between ecoregions
```{r, echo=FALSE}
# Convert data into community matrix sith species as columns and communities (sites) as rows - remove all columns except for species columns 
comm_matrix<-AllSpp[,6:ncol(AllSpp)] %>% as.matrix()
NMDS=metaMDS(comm_matrix, k=2, distance="bray") 
stressplot(NMDS)
NMDS #Stress ok 

#Get data scores and make new dataframe with site, ecoregion and collection date information
data.scores<-as.data.frame(scores(NMDS))
data.scores$date <- AllSpp$Date_comb
data.scores$Site <-AllSpp$Site_Grouping
data.scores$Ecoregion <-AllSpp$Ecoregion
head(data.scores)

#Gets NMDS info for each behavior
species.scores<-as.data.frame(scores(NMDS, "species"))
species.scores$species<-rownames(species.scores)

## Plot it using ggplot
ggplot() + geom_point(data=data.scores, aes(x=NMDS1, y=NMDS2, colour=Ecoregion), size=2)+ geom_text(data=species.scores, aes(x=NMDS1, y=NMDS2, label=species), position=position_jitter(width=1.5, height=1.5))+scale_x_continuous(limits = c(-2.5, 2))

## Anosim - are communities different by ecoregion
ano = anosim(comm_matrix, data.scores$Ecoregion, distance = "bray", permutations = 9999)
ano

#No significant differences between ecoregions in community composition
```


# Species Accumulation Curves 
```{r}
# Need to convert dataframe to a matrix and remove first column 
SpeciesAcc<-AllSpp %>% select(!Site_Grouping,) %>% as.matrix()
SpeciesAcc
#Methods for species accumulation
#"collector" adds sites in the order they happen to be in the data
# "random" adds sites in random order
# "exact" finds the expected (mean) species richness
# "coleman" finds the expected richness following Coleman et al. 1982
# "rarefaction" finds the mean when accumulating individuals instead of sites.

##Site level collection - demonstrates if we sampled enough sites 
accCurve<-specaccum(SpeciesAcc, method="random", permutations=100)
plot(accCurve$sites, accCurve$richness)

## Individual Collection - demonstrates we sampled enough individuals 
rareCurve<-specaccum(SpeciesAcc, method="rarefaction", permutations=100)
plot(rareCurve$individual, rareCurve$richness)

## Rarefaction curves for each site 
OA<-SpeciesAcc[,1]
OAcurve<-specaccum(OA, method="rarefaction", permutations=100)
OAcurve
plot(OAcurve$individuals, OAcurve$richness)
```



